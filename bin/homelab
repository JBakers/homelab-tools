#!/bin/bash
set -euo pipefail

# Homelab Management Menu
# Author: J.Bakers
# Version: 3.2.0

# Kleuren (zelfde stijl als MOTD)
CYAN='\033[0;36m'
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
RESET='\033[0m'

# Help functie (kort overzicht)
show_help() {
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ  HOMELAB MANAGEMENT TOOLS v3.2.0              â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}${BLUE}AVAILABLE COMMANDS:${RESET}"
    echo ""
    echo -e "  ${YELLOW}generate-motd${RESET}         Generate MOTD for a service"
    echo -e "  ${YELLOW}bulk-generate-motd${RESET}    Generate MOTDs for all hosts"
    echo -e "  ${YELLOW}deploy-motd${RESET}           Deploy MOTD to container"
    echo -e "  ${YELLOW}cleanup-keys${RESET}          Remove old SSH keys"
    echo -e "  ${YELLOW}list-templates${RESET}        Show all MOTD templates"
    echo -e "  ${YELLOW}edit-ssh${RESET}              Edit SSH configuration"
    echo -e "  ${YELLOW}copykey${RESET}               Distribute SSH keys"
    echo ""
    echo -e "${BOLD}${BLUE}USAGE:${RESET}"
    echo -e "  ${GREEN}homelab${RESET}               Show interactive menu"
    echo -e "  ${GREEN}homelab help${RESET}          Show detailed help"
    echo -e "  ${GREEN}<command> --help${RESET}     Show help for specific command"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

# Gedetailleerde help
show_detailed_help() {
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘        ğŸ  HOMELAB TOOLS - DETAILED HELP                 â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}${BLUE}MOTD (Message of the Day) SYSTEM:${RESET}"
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "Creates beautiful, dynamic login screens for your servers with:"
    echo -e "  â€¢ Rainbow ASCII art (using toilet)"
    echo -e "  â€¢ System information (hostname, IP, uptime)"
    echo -e "  â€¢ Service-specific info (Docker, Pi-hole, etc.)"
    echo -e "  â€¢ Clickable Web UI links"
    echo ""
    echo -e "${BOLD}${YELLOW}Workflow:${RESET}"
    echo -e "  1. ${GREEN}generate-motd <hostname>${RESET}  â†’ Create template"
    echo -e "  2. ${GREEN}deploy-motd <hostname>${RESET}    â†’ Deploy to host"
    echo -e "  3. ${GREEN}ssh <hostname>${RESET}            â†’ See your beautiful MOTD!"
    echo ""
    echo -e "The MOTD is generated dynamically at each login,"
    echo -e "so information like uptime is always current."
    echo ""
    echo -e "${BOLD}${BLUE}HOST MANAGEMENT:${RESET}"
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "Your hosts are configured in ~/.ssh/config"
    echo -e "All homelab tools use this for host access."
    echo ""
    echo -e "  ${GREEN}edit-hosts${RESET}     Edit your host configuration"
    echo -e "  ${GREEN}copykey${RESET}        Distribute SSH keys to all hosts"
    echo ""
    echo -e "${BOLD}${BLUE}REQUIREMENTS:${RESET}"
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "  â€¢ toilet (for ASCII art): ${GREEN}sudo apt install toilet toilet-fonts${RESET}"
    echo -e "  â€¢ figlet (fallback): ${GREEN}sudo apt install figlet${RESET}"
    echo ""
    echo -e "${BOLD}${BLUE}EXAMPLES:${RESET}"
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "  ${GREEN}bulk-generate-motd${RESET}"
    echo -e "    â†’ Scan host list and generate MOTDs for all hosts"
    echo ""
    echo -e "  ${GREEN}generate-motd jellyfin${RESET}"
    echo -e "    â†’ Create template for Jellyfin server"
    echo ""
    echo -e "  ${GREEN}deploy-motd jellyfin${RESET}"
    echo -e "    â†’ Deploy MOTD to Jellyfin server"
    echo ""
    echo -e "  ${GREEN}cleanup-keys 192.168.1.30${RESET}"
    echo -e "    â†’ Remove old SSH keys for this IP"
    echo ""
    echo -e "${BOLD}${BLUE}MORE INFO:${RESET}"
    echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo -e "  GitHub: https://github.com/JBakers/homelab-tools"
    echo -e "  Each command: ${GREEN}<command> --help${RESET}"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

# Toon het hoofd menu
show_menu() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ  HOMELAB MANAGEMENT TOOLS v3.2.0            â•‘"
    echo -e "â•‘                  by J.Bakers                           â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}${BLUE}What would you like to do?${RESET}"
    echo ""
    echo -e "  ${YELLOW}1${RESET}) ${GREEN}MOTD Management${RESET}     - Create and deploy login screens"
    echo -e "  ${YELLOW}2${RESET}) ${GREEN}Configuration${RESET}       - Edit hosts and settings"
    echo -e "  ${YELLOW}3${RESET}) ${GREEN}SSH Tools${RESET}           - Manage keys and access"
    echo ""
    echo -e "  ${YELLOW}h${RESET}) ${MAGENTA}Help${RESET}                - Show detailed help"
    echo -e "  ${YELLOW}q${RESET}) ${RED}Quit${RESET}                - Exit"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

# MOTD submenu
show_motd_menu() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ“‹ MOTD MANAGEMENT                             â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "  ${YELLOW}1${RESET}) ${GREEN}Generate MOTD${RESET}           - Create template for one host"
    echo -e "  ${YELLOW}2${RESET}) ${GREEN}Bulk Generate${RESET}           - Create for all hosts"
    echo -e "  ${YELLOW}3${RESET}) ${GREEN}Deploy MOTD${RESET}             - Upload to host"
    echo -e "  ${YELLOW}4${RESET}) ${GREEN}List Templates${RESET}          - View all templates"
    echo ""
    echo -e "  ${YELLOW}b${RESET}) ${MAGENTA}Back${RESET}                    - Return to main menu"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

# Configuration submenu
show_config_menu() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         âš™ï¸  CONFIGURATION                               â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "  ${YELLOW}1${RESET}) ${GREEN}Edit Hosts${RESET}              - Manage host list (~/.ssh/config)"
    echo -e "  ${YELLOW}2${RESET}) ${GREEN}Edit Settings${RESET}           - Configure homelab tools"
    echo ""
    echo -e "  ${YELLOW}b${RESET}) ${MAGENTA}Back${RESET}                    - Return to main menu"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

# SSH submenu
show_ssh_menu() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ”‘ SSH TOOLS                                    â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "  ${YELLOW}1${RESET}) ${GREEN}Copy SSH Key${RESET}            - Distribute key to hosts"
    echo -e "  ${YELLOW}2${RESET}) ${GREEN}Cleanup Old Keys${RESET}        - Remove outdated host keys"
    echo ""
    echo -e "  ${YELLOW}b${RESET}) ${MAGENTA}Back${RESET}                    - Return to main menu"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

# Als --help of help wordt meegegeven
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
elif [[ "${1:-}" == "help" ]]; then
    show_detailed_help
    exit 0
fi

# Interactief menu
while true; do
    show_menu
    echo -ne "${BOLD}${GREEN}Choice:${RESET} "
    read -r choice
    
    case $choice in
        1)
            # MOTD submenu
            while true; do
                show_motd_menu
                echo -ne "${BOLD}${GREEN}Choice:${RESET} "
                read -r submenu
                
                case $submenu in
                    1)
                        echo ""
                        read -p "$(echo -e ${CYAN}Service name:${RESET} )" service
                        if [[ -n "$service" ]]; then
                            generate-motd "$service"
                        else
                            echo -e "${RED}âœ— No service name provided${RESET}"
                        fi
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    2)
                        echo ""
                        bulk-generate-motd
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    3)
                        echo ""
                        read -p "$(echo -e ${CYAN}Service name:${RESET} )" service
                        if [[ -n "$service" ]]; then
                            deploy-motd "$service"
                        else
                            echo -e "${RED}âœ— No service name provided${RESET}"
                        fi
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    4)
                        echo ""
                        list-templates
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    b|B|back)
                        break
                        ;;
                    *)
                        echo -e "${RED}âœ— Invalid choice${RESET}"
                        sleep 1
                        ;;
                esac
            done
            ;;
        2)
            # Configuration submenu
            while true; do
                show_config_menu
                echo -ne "${BOLD}${GREEN}Choice:${RESET} "
                read -r submenu
                
                case $submenu in
                    1)
                        echo ""
                        edit-hosts
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    2)
                        echo ""
                        edit-config
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    b|B|back)
                        break
                        ;;
                    *)
                        echo -e "${RED}âœ— Invalid choice${RESET}"
                        sleep 1
                        ;;
                esac
            done
            ;;
        3)
            # SSH submenu
            while true; do
                show_ssh_menu
                echo -ne "${BOLD}${GREEN}Choice:${RESET} "
                read -r submenu
                
                case $submenu in
                    1)
                        echo ""
                        copykey
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    2)
                        echo ""
                        read -p "$(echo -e ${CYAN}IP address or hostname:${RESET} )" host
                        if [[ -n "$host" ]]; then
                            cleanup-keys "$host"
                        else
                            echo -e "${RED}âœ— No host provided${RESET}"
                        fi
                        echo ""
                        read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                        ;;
                    b|B|back)
                        break
                        ;;
                    *)
                        echo -e "${RED}âœ— Invalid choice${RESET}"
                        sleep 1
                        ;;
                esac
            done
            ;;
        iddqd|IDDQD)
            clear
            echo ""
            echo -e "${RED}${BOLD}"
            cat << 'DOOMGUY'

            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—
            â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘
            â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘
            â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘
            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘
            â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•
            
DOOMGUY
            echo -e "${RESET}"
            echo -e "${GREEN}              ğŸ® ${BOLD}GOD MODE ACTIVATED${RESET}${GREEN} ğŸ®${RESET}"
            echo ""
            echo -e "${YELLOW}         Degreelessness Mode: ${BOLD}INVINCIBLE${RESET}"
            echo ""
            sleep 2
            ;;
        h|H)
            show_detailed_help
            echo ""
            read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
            ;;
        q|Q|quit|exit)
            echo -e "${GREEN}âœ“ Goodbye!${RESET}"
            exit 0
            ;;
        *)
            echo -e "${RED}âœ— Invalid choice${RESET}"
            sleep 1
            ;;
    esac
done
