#!/bin/bash
set -euo pipefail

# Homelab Management Menu
# Author: J.Bakers
# Version: See VERSION file

# Load shared menu helper library
# Resolve symlinks to find the actual installation directory
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
source "$LIB_DIR/menu-helpers.sh"
source "$LIB_DIR/version.sh"
# Source validators
if [[ -f "$LIB_DIR/validators.sh" ]]; then
    source "$LIB_DIR/validators.sh"
fi

# Colors
CYAN="$MENU_CYAN"
GREEN="$MENU_GREEN"
YELLOW="$MENU_YELLOW"
RED="$MENU_RED"
BOLD="$MENU_BOLD"
DIM="$MENU_DIM"
RESET="$MENU_RESET"

# Fallback simple menu (numbered) for terminals where arrow navigation fails.
# Trigger with HLT_MENU_SIMPLE=1 or when stdin is not a TTY.
simple_menu() {
    local title="$1"
    shift
    local -a options=("$@")

    echo "" >&2
    echo -e "${BOLD}${CYAN}${title}${RESET}" >&2
    local idx=1
    for option in "${options[@]}"; do
        local label desc
        if [[ "$option" =~ \| ]]; then
            label="${option%%|*}"
            desc="${option##*|}"
        else
            label="$option"
            desc=""
        fi
        echo "  ${idx}) ${label}${desc:+ - ${desc}}" >&2
        ((idx++))
    done
    echo "" >&2

    local choice
    while true; do
        read -rp "Select an option [1-${#options[@]}] (q to quit): " choice < /dev/tty || return 1
        if [[ "$choice" =~ ^[Qq]$ ]]; then
            # Map quit to last index if present, else return -1
            if [[ "${options[-1]}" == "QUIT" ]]; then
                echo "$((${#options[@]} - 1))"
            else
                echo "-1"
            fi
            return 0
        elif [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#options[@]} )); then
            echo "$((choice - 1))"
            return 0
        else
            echo "Invalid choice. Try again." >&2
        fi
    done
}

# Wrapper to choose arrow menu or simple menu
# Sets global HLT_MENU_RESULT variable with the selection
choose_menu() {
    local title="$1"
    shift
    if [[ "${HLT_MENU_SIMPLE:-0}" == "1" ]]; then
        simple_menu "$title" "$@"
        # simple_menu echoes result, capture it
        return
    else
        show_arrow_menu "$title" "$@"
        # show_arrow_menu sets HLT_MENU_RESULT
    fi
}

# Read user input with q to cancel
# Usage: read_input "prompt" variable_name
# Returns: 0 if input provided, 1 if cancelled (q pressed)
# Sets the variable to the input value
read_input() {
    local prompt="$1"
    local var_name="$2"
    local input
    
    read -p "$(echo -e "${CYAN}${prompt}${RESET} ${YELLOW}(q=cancel)${RESET}: ")" input
    
    if [[ "$input" == "q" || "$input" == "Q" ]]; then
        return 1
    fi
    
    # Use printf -v for safe variable assignment (prevents eval injection)
    printf -v "$var_name" '%s' "$input"
    return 0
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Function: wait_for_continue
# Description: Wait for user to press Enter or q to continue
# Arguments: None
# Returns: 0 if Enter pressed, 1 if q pressed
# Globals: YELLOW, RESET
# Notes: Reads single character from /dev/tty without echo
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wait_for_continue() {
    local key
    echo -e "${YELLOW}Press Enter to continue...${RESET}"
    read -rsn1 key < /dev/tty 2>/dev/null || true
    if [[ "$key" == "q" || "$key" == "Q" ]]; then
        return 1
    fi
    return 0
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Function: show_usage_short
# Description: Display short usage message
# Arguments: None
# Returns: 0
# Globals: HLT_VERSION_DISPLAY
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_usage_short() {
    echo -e "homelab ${HLT_VERSION_DISPLAY}\n"
    echo "Usage: homelab       Start interactive menu"
    echo "       homelab help  Show help"
}

# Short help overview
show_help() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${BOLD}${CYAN}â•‘         ğŸ  Homelab Tools ${HLT_VERSION_DISPLAY}                       â•‘${RESET}"
    echo -e "${BOLD}${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}${GREEN}Getting Started:${RESET}"
    echo -e "  Run ${CYAN}homelab${RESET} to open the interactive menu."
    echo -e "  Everything is accessible from there!"
    echo ""
    echo -e "${BOLD}${CYAN}Main Features:${RESET}"
    echo -e "  ${YELLOW}MOTD Tools${RESET}        Generate & deploy login banners"
    echo -e "  ${YELLOW}Configuration${RESET}     Manage SSH hosts & settings"
    echo -e "  ${YELLOW}Backups${RESET}           View & manage backup files"
    echo ""
    echo -e "${BOLD}${CYAN}Navigation:${RESET}"
    echo -e "  ${YELLOW}â†‘â†“${RESET} or ${YELLOW}j/k${RESET}  Navigate menus"
    echo -e "  ${YELLOW}Enter${RESET}      Select option"
    echo -e "  ${YELLOW}q${RESET}          Cancel/back"
    echo ""
    echo -e "${DIM}GitHub: github.com/JBakers/homelab-tools${RESET}"
    echo ""
}

# Gedetailleerde help
show_detailed_help() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${BOLD}${CYAN}â•‘         ğŸ  Homelab Tools - Full Guide                      â•‘${RESET}"
    echo -e "${BOLD}${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}${GREEN}ğŸš€ Getting Started${RESET}"
    echo -e "  Just run ${CYAN}homelab${RESET} and use the interactive menu!"
    echo -e "  All features are accessible from there."
    echo ""
    echo -e "${BOLD}${CYAN}ğŸ“ MOTD Tools${RESET}"
    echo -e "  Generate beautiful login banners for your servers."
    echo -e "  60+ services auto-detected (Pi-hole, Plex, *arr, etc.)"
    echo -e "  Choose clean design or colorful ASCII art styles."
    echo ""
    echo -e "${BOLD}${CYAN}ğŸ–¥ï¸  Configuration${RESET}"
    echo -e "  Manage SSH hosts (add/edit/delete/bulk operations)"
    echo -e "  Distribute SSH keys to all servers"
    echo -e "  Clean up stale host keys after container rebuilds"
    echo ""
    echo -e "${BOLD}${CYAN}ğŸ’¾ Backups${RESET}"
    echo -e "  View, archive, move or delete backup files"
    echo -e "  Backups created automatically during install/updates"
    echo ""
    echo -e "${BOLD}${CYAN}ğŸ’¡ Tips${RESET}"
    echo -e "  â€¢ Press ${YELLOW}q${RESET} to cancel any prompt"
    echo -e "  â€¢ Navigate with ${YELLOW}â†‘â†“${RESET} arrow keys or ${YELLOW}j/k${RESET}"
    echo -e "  â€¢ Enter selects, q goes back"
    echo ""
    echo -e "${DIM}GitHub: github.com/JBakers/homelab-tools${RESET}"
    echo ""
}

# MOTD submenu help
show_motd_help() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ“ MOTD Management - Help                         â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}${GREEN}Workflow:${RESET}"
    echo -e "  ${CYAN}1.${RESET} Generate  â†’ Create template for a host"
    echo -e "  ${CYAN}2.${RESET} Deploy    â†’ Upload to remote host"
    echo -e "  ${CYAN}3.${RESET} SSH login â†’ See your MOTD!"
    echo ""
    echo -e "${BOLD}${CYAN}Menu Options:${RESET}"
    echo -e "  ${YELLOW}Generate${RESET}          Create MOTD for one host"
    echo -e "  ${YELLOW}Bulk Generate${RESET}     Create for all hosts at once"
    echo -e "  ${YELLOW}Deploy${RESET}            Upload template to host"
    echo -e "  ${YELLOW}Undeploy${RESET}          Remove MOTD from host"
    echo -e "  ${YELLOW}List Templates${RESET}    View, preview or check status"
    echo -e "  ${YELLOW}Delete Templates${RESET}  Remove template files"
    echo ""
    echo -e "${BOLD}${CYAN}Tips:${RESET}"
    echo -e "  â€¢ 60+ services auto-detected (Pi-hole, Plex, *arr, etc.)"
    echo -e "  â€¢ Choose clean design or ASCII art styles"
    echo -e "  â€¢ Templates saved in ~/.local/share/homelab-tools/templates/"
    echo ""
    wait_for_continue
}

# Backup Management Menu
backup_management_menu() {
    while true; do
        clear
        echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo -e "â•‘         ğŸ’¾ Backup Management                              â•‘"
        echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        
        # Find all backups
        local -a backup_files=()
        local -a backup_types=()
        local -a backup_sizes=()
        
        # .bashrc backups
        while IFS= read -r -d '' file; do
            backup_files+=("$file")
            backup_types+=("bashrc")
            backup_sizes+=("$(du -h "$file" 2>/dev/null | cut -f1)")
        done < <(find "$HOME" -maxdepth 1 -name ".bashrc.backup*" -type f -print0 2>/dev/null)
        
        # homelab-tools backups in home (renamed from legacy)
        while IFS= read -r -d '' file; do
            backup_files+=("$file")
            backup_types+=("home")
            backup_sizes+=("$(du -sh "$file" 2>/dev/null | cut -f1)")
        done < <(find "$HOME" -maxdepth 1 -name "homelab-tools.backup*" -type d -print0 2>/dev/null)
        
        # /opt backups
        while IFS= read -r -d '' file; do
            backup_files+=("$file")
            backup_types+=("install")
            backup_sizes+=("$(du -sh "$file" 2>/dev/null | cut -f1)")
        done < <(find /opt -maxdepth 1 -name "homelab-tools.backup*" -type d -print0 2>/dev/null)
        
        # SSH config backups
        while IFS= read -r -d '' file; do
            backup_files+=("$file")
            backup_types+=("ssh")
            backup_sizes+=("$(du -h "$file" 2>/dev/null | cut -f1)")
        done < <(find "$HOME/.ssh" -maxdepth 1 -name "config.backup*" -type f -print0 2>/dev/null)
        
        # Template exports
        while IFS= read -r -d '' file; do
            backup_files+=("$file")
            backup_types+=("export")
            backup_sizes+=("$(du -h "$file" 2>/dev/null | cut -f1)")
        done < <(find "$HOME" -maxdepth 1 -name "ssh-hosts-export-*.txt" -type f -print0 2>/dev/null)
        
        local total=${#backup_files[@]}
        
        if [[ $total -eq 0 ]]; then
            echo -e "${YELLOW}No backups found${RESET}"
            echo ""
            echo -e "${DIM}Backups are created automatically when:${RESET}"
            echo -e "  - Installing/updating homelab-tools"
            echo -e "  - Editing hosts (SSH config backup)"
            echo -e "  - Making changes to .bashrc"
            echo ""
            read -rp "$(echo -e "${CYAN}Press Enter to go back...${RESET}")"
            return 0
        fi
        
        # Calculate total size
        local total_size
        total_size=$(du -ch "${backup_files[@]}" 2>/dev/null | tail -1 | cut -f1)
        
        echo -e "${BOLD}Found ${GREEN}$total${RESET}${BOLD} backup(s) (Total: ${YELLOW}$total_size${RESET}${BOLD})${RESET}"
        echo ""
        echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
        echo ""
        
        # Display backups grouped by type
        echo -e "${BOLD}${CYAN}bashrc${RESET} ${DIM}(~/.bashrc.backup*)${RESET}"
        local bashrc_count=0
        for i in "${!backup_files[@]}"; do
            if [[ "${backup_types[$i]}" == "bashrc" ]]; then
                local name
                name=$(basename "${backup_files[$i]}")
                echo -e "  ${GREEN}â€¢${RESET} $name ${DIM}(${backup_sizes[$i]})${RESET}"
                bashrc_count=$((bashrc_count + 1))
            fi
        done
        [[ $bashrc_count -eq 0 ]] && echo -e "  ${DIM}(none)${RESET}"
        echo ""
        
        echo -e "${BOLD}${CYAN}SSH Config${RESET} ${DIM}(~/.ssh/config.backup*)${RESET}"
        local ssh_count=0
        for i in "${!backup_files[@]}"; do
            if [[ "${backup_types[$i]}" == "ssh" ]]; then
                local name
                name=$(basename "${backup_files[$i]}")
                echo -e "  ${GREEN}â€¢${RESET} $name ${DIM}(${backup_sizes[$i]})${RESET}"
                ssh_count=$((ssh_count + 1))
            fi
        done
        [[ $ssh_count -eq 0 ]] && echo -e "  ${DIM}(none)${RESET}"
        echo ""
        
        echo -e "${BOLD}${CYAN}HLT Install${RESET} ${DIM}(/opt/homelab-tools.backup*)${RESET}"
        local install_count=0
        for i in "${!backup_files[@]}"; do
            if [[ "${backup_types[$i]}" == "install" ]]; then
                local name
                name=$(basename "${backup_files[$i]}")
                echo -e "  ${GREEN}â€¢${RESET} $name ${DIM}(${backup_sizes[$i]})${RESET}"
                install_count=$((install_count + 1))
            fi
        done
        [[ $install_count -eq 0 ]] && echo -e "  ${DIM}(none)${RESET}"
        echo ""
        
        echo -e "${BOLD}${CYAN}Home Backups${RESET} ${DIM}(~/homelab-tools.backup*)${RESET}"
        local home_count=0
        for i in "${!backup_files[@]}"; do
            if [[ "${backup_types[$i]}" == "home" ]]; then
                local name
                name=$(basename "${backup_files[$i]}")
                echo -e "  ${GREEN}â€¢${RESET} $name ${DIM}(${backup_sizes[$i]})${RESET}"
                home_count=$((home_count + 1))
            fi
        done
        [[ $home_count -eq 0 ]] && echo -e "  ${DIM}(none)${RESET}"
        echo ""
        
        echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
        echo ""
        
        # Menu options
        choose_menu "ğŸ’¾ Backup Actions" \
            "Archive all|Create .tar.gz of all backups" \
            "Move to folder|Move backups to custom location" \
            "Delete all|Remove all backup files" \
            "Delete by type|Remove specific backup types" \
            "BACK"
        local choice="$HLT_MENU_RESULT"
        
        case "$choice" in
            0)
                # Archive all
                clear
                echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo -e "â•‘         ğŸ“¦ Archive Backups                                â•‘"
                echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                
                local default_archive
                default_archive="$HOME/homelab-backups-$(date +%Y%m%d-%H%M%S).tar.gz"
                echo -e "${BOLD}Archive destination:${RESET}"
                echo -e "${DIM}Default: $default_archive${RESET}"
                echo ""
                read -rp "$(echo -e "${CYAN}Path (Enter for default, q to cancel): ${RESET}")" archive_path
                
                if [[ "$archive_path" == "q" ]] || [[ "$archive_path" == "Q" ]]; then
                    continue
                fi
                
                archive_path="${archive_path:-$default_archive}"
                
                # Validate archive path to prevent directory traversal attacks
                if ! validate_path "$archive_path"; then
                    echo -e "${RED}âœ— Error: Invalid path (no absolute paths or traversal sequences allowed)${RESET}"
                    sleep 2
                    continue
                fi
                
                echo ""
                echo -e "${YELLOW}â†’${RESET} Creating archive..."
                
                if tar -czf "$archive_path" "${backup_files[@]}" 2>/dev/null; then
                    echo -e "${GREEN}âœ“${RESET} Archive created: $archive_path"
                    echo -e "  Size: $(du -h "$archive_path" | cut -f1)"
                else
                    echo -e "${RED}âœ—${RESET} Failed to create archive"
                fi
                echo ""
                read -rp "$(echo -e "${CYAN}Press Enter to continue...${RESET}")"
                ;;
            1)
                # Move to folder
                clear
                echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo -e "â•‘         ğŸ“ Move Backups                                   â•‘"
                echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                
                echo -e "${BOLD}Enter destination folder:${RESET}"
                echo -e "${DIM}Example: ~/backup-archive or /mnt/nas/backups${RESET}"
                echo ""
                read -rp "$(echo -e "${CYAN}Path (q to cancel): ${RESET}")" dest_folder
                
                if [[ "$dest_folder" == "q" ]] || [[ "$dest_folder" == "Q" ]] || [[ -z "$dest_folder" ]]; then
                    continue
                fi
                
                # Expand ~ if used
                dest_folder="${dest_folder/#\~/$HOME}"
                
                # Validate destination path to prevent directory traversal attacks
                if ! validate_path "$dest_folder"; then
                    echo -e "${RED}âœ— Error: Invalid path (no absolute paths or traversal sequences allowed)${RESET}"
                    sleep 2
                    continue
                fi
                
                if [[ ! -d "$dest_folder" ]]; then
                    read -rp "$(echo -e "${YELLOW}Create directory $dest_folder? (y/N): ${RESET}")" create_dir
                    if [[ "$create_dir" =~ ^[Yy]$ ]]; then
                        mkdir -p "$dest_folder" || { echo -e "${RED}âœ— Failed to create directory${RESET}"; sleep 2; continue; }
                    else
                        continue
                    fi
                fi
                
                echo ""
                local moved=0
                for file in "${backup_files[@]}"; do
                    if mv "$file" "$dest_folder/" 2>/dev/null; then
                        echo -e "${GREEN}âœ“${RESET} Moved: $(basename "$file")"
                        moved=$((moved + 1))
                    else
                        echo -e "${RED}âœ—${RESET} Failed: $(basename "$file") ${DIM}(may need sudo)${RESET}"
                    fi
                done
                
                echo ""
                echo -e "${GREEN}âœ“${RESET} Moved $moved backup(s) to $dest_folder"
                read -rp "$(echo -e "${CYAN}Press Enter to continue...${RESET}")"
                ;;
            2)
                # Delete all
                clear
                echo -e "${BOLD}${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo -e "â•‘         âš ï¸  Delete ALL Backups                           â•‘"
                echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                echo -e "${BOLD}The following $total backup(s) will be deleted:${RESET}"
                echo ""
                for file in "${backup_files[@]}"; do
                    echo -e "  ${RED}âœ—${RESET} $file"
                done
                echo ""
                
                read -rp "$(echo -e "${RED}${BOLD}Type 'DELETE' to confirm: ${RESET}")" confirm
                
                if [[ "$confirm" == "DELETE" ]]; then
                    local deleted=0
                    for file in "${backup_files[@]}"; do
                        if rm -rf "$file" 2>/dev/null; then
                            deleted=$((deleted + 1))
                        else
                            # Try with sudo for /opt backups
                            if sudo rm -rf "$file" 2>/dev/null; then
                                deleted=$((deleted + 1))
                            fi
                        fi
                    done
                    echo ""
                    echo -e "${GREEN}âœ“${RESET} Deleted $deleted backup(s)"
                else
                    echo -e "${YELLOW}âœ— Cancelled${RESET}"
                fi
                sleep 2
                ;;
            3)
                # Delete by type
                clear
                echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo -e "â•‘         ğŸ—‘ï¸  Delete by Type                               â•‘"
                echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                
                choose_menu "Select type to delete" \
                    "bashrc backups|~/.bashrc.backup* ($bashrc_count files)" \
                    "SSH config backups|~/.ssh/config.backup* ($ssh_count files)" \
                    "HLT install backups|/opt/*.backup* ($install_count folders)" \
                    "Home backups|~/homelab-tools.backup* ($home_count folders)" \
                    "BACK"
                local type_choice="$HLT_MENU_RESULT"
                
                local type_to_delete=""
                case "$type_choice" in
                    0) type_to_delete="bashrc" ;;
                    1) type_to_delete="ssh" ;;
                    2) type_to_delete="install" ;;
                    3) type_to_delete="home" ;;
                    *) continue ;;
                esac
                
                # Collect files of this type
                local -a files_to_delete=()
                for i in "${!backup_files[@]}"; do
                    if [[ "${backup_types[$i]}" == "$type_to_delete" ]]; then
                        files_to_delete+=("${backup_files[$i]}")
                    fi
                done
                
                if [[ ${#files_to_delete[@]} -eq 0 ]]; then
                    echo -e "${YELLOW}No backups of this type${RESET}"
                    sleep 1
                    continue
                fi
                
                echo ""
                echo -e "${BOLD}Delete ${#files_to_delete[@]} $type_to_delete backup(s)?${RESET}"
                read -rp "$(echo -e "${YELLOW}Confirm (y/N): ${RESET}")" confirm
                
                if [[ "$confirm" =~ ^[Yy]$ ]]; then
                    local deleted=0
                    for file in "${files_to_delete[@]}"; do
                        if rm -rf "$file" 2>/dev/null || sudo rm -rf "$file" 2>/dev/null; then
                            echo -e "${GREEN}âœ“${RESET} Deleted: $(basename "$file")"
                            deleted=$((deleted + 1))
                        fi
                    done
                    echo ""
                    echo -e "${GREEN}âœ“${RESET} Deleted $deleted backup(s)"
                else
                    echo -e "${YELLOW}âœ— Cancelled${RESET}"
                fi
                sleep 2
                ;;
            -1|4)
                return 0
                ;;
        esac
    done
}

# Configuration submenu help
show_config_help() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ–¥ï¸  Configuration - Help                          â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}${CYAN}Menu Options:${RESET}"
    echo -e "  ${YELLOW}Manage Hosts${RESET}        Add, edit, delete SSH hosts"
    echo -e "  ${YELLOW}Distribute Key${RESET}      Copy SSH key to all hosts"
    echo -e "  ${YELLOW}Cleanup Keys${RESET}        Remove stale known_hosts entries"
    echo -e "  ${YELLOW}Settings${RESET}            Domain suffix & IP detection"
    echo -e "  ${YELLOW}Uninstall${RESET}           Remove homelab-tools"
    echo ""
    echo -e "${BOLD}${CYAN}Host Management Features:${RESET}"
    echo -e "  â€¢ Add new hosts with guided wizard"
    echo -e "  â€¢ Edit existing host settings"
    echo -e "  â€¢ Search and filter hosts"
    echo -e "  â€¢ Bulk operations (export, backup, batch delete)"
    echo ""
    echo -e "${BOLD}${CYAN}SSH Key Tips:${RESET}"
    echo -e "  â€¢ Use ${GREEN}copykey${RESET} after adding new hosts"
    echo -e "  â€¢ Use ${GREEN}cleanup-keys${RESET} after rebuilding containers"
    echo ""
    wait_for_continue
}

# Note: Menu display functions removed - now using show_arrow_menu from lib/menu-helpers.sh

# Als --help of help wordt meegegeven
if [[ "${1:-}" == "--usage" ]]; then
    show_usage_short
    exit 0
elif [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
elif [[ "${1:-}" == "help" ]]; then
    show_detailed_help
    exit 0
fi

# If stdin is not a TTY and no args were provided, print concise usage and exit
if [[ ! -t 0 && $# -eq 0 ]]; then
    show_usage_short
    exit 0
fi

# Interactief menu met arrow navigation
while true; do
    # Show main menu with arrow navigation (version from lib/version.sh)
    choose_menu "ğŸ  Homelab Tools ${HLT_VERSION_DISPLAY}" \
        "ğŸ“ MOTD Management|Generate, deploy & manage MOTDs" \
        "ğŸ–¥ï¸  Configuration|Hosts, SSH keys & settings" \
        "ğŸ’¾ Backups|View & manage backup files" \
        "HELP" "QUIT"
    result="$HLT_MENU_RESULT"

    case "$result" in
        0)
            # MOTD submenu
            while true; do
                choose_menu "ğŸ“ MOTD Management" \
                    "âœ¨ Generate|Create MOTD for one host" \
                    "ğŸ“¦ Bulk Generate|Create for all hosts at once" \
                    "ğŸš€ Deploy|Upload MOTD to remote host" \
                    "â– Undeploy|Remove MOTD from host" \
                    "ğŸ“‹ List Templates|View & preview templates" \
                    "âŒ Delete Templates|Remove template files" \
                    "HELP" "BACK"
                submenu_result="$HLT_MENU_RESULT"

                case "$submenu_result" in
                    0)
                        # Generate MOTD - with host selection
                        clear
                        echo ""
                        echo -e "${BOLD}Generate MOTD${RESET}"
                        echo ""
                        
                        # Get list of hosts from SSH config
                        ssh_config="$HOME/.ssh/config"
                        hosts=()
                        if [[ -f "$ssh_config" ]]; then
                            mapfile -t hosts < <(grep "^Host " "$ssh_config" | awk '{print $2}' | grep -v '\*' | sort -u)
                        fi
                        
                        if [[ ${#hosts[@]} -gt 0 ]]; then
                            echo -e "${CYAN}Choose option:${RESET}"
                            echo -e "  ${GREEN}1${RESET}) Select from existing hosts (${#hosts[@]} found)"
                            echo -e "  ${GREEN}2${RESET}) Enter new service name"
                            echo ""
                            read -p "$(echo -e "${CYAN}Choice (1/2):${RESET} ")" gen_choice
                            
                            if [[ "$gen_choice" == "1" ]]; then
                                # Build menu options from hosts
                                host_options=()
                                for host in "${hosts[@]}"; do
                                    host_options+=("$host|Generate MOTD for $host")
                                done
                                host_options+=("BACK")
                                
                                choose_menu "Select Host" "${host_options[@]}"
                                host_idx="$HLT_MENU_RESULT"
                                
                                if [[ $host_idx -ge 0 ]] && [[ $host_idx -lt ${#hosts[@]} ]]; then
                                    selected_host="${hosts[$host_idx]}"
                                    clear
                                    generate-motd "$selected_host"
                                    echo ""
                                    wait_for_continue
                                fi
                            elif [[ "$gen_choice" == "2" ]]; then
                                if read_input "Service name" service && [[ -n "$service" ]]; then
                                    generate-motd "$service"
                                    echo ""
                                    wait_for_continue
                                fi
                            fi
                        else
                            # No hosts found, fall back to manual entry
                            if read_input "Service name" service && [[ -n "$service" ]]; then
                                generate-motd "$service"
                                echo ""
                                wait_for_continue
                            fi
                        fi
                        ;;
                    1)
                        # Bulk Generate
                        bulk-generate-motd
                        # No wait_for_continue - has own flow
                        ;;
                    2)
                        # Deploy MOTD
                        clear
                        echo ""
                        if read_input "Service name" service && [[ -n "$service" ]]; then
                            deploy-motd "$service"
                            echo ""
                            wait_for_continue
                        fi
                        ;;
                    3)
                        # Undeploy MOTD
                        clear
                        echo ""
                        echo -e "${BOLD}Undeploy MOTD${RESET}"
                        echo ""
                        echo "1) Remove from specific host"
                        echo "2) Remove from all hosts"
                        echo ""
                        if read_input "Choice [1-2]" choice && [[ -n "$choice" ]]; then
                            case "$choice" in
                                1)
                                    if read_input "Service name" service && [[ -n "$service" ]]; then
                                        undeploy-motd "$service"
                                    fi
                                    ;;
                                2)
                                    undeploy-motd --all
                                    ;;
                                *)
                                    echo -e "${YELLOW}Invalid choice${RESET}"
                                    ;;
                            esac
                            echo ""
                            wait_for_continue
                        fi
                        ;;
                    4)
                        # List Templates
                        clear
                        list-templates
                        # No wait_for_continue - has own menu
                        ;;
                    5)
                        # Delete Template
                        clear
                        delete-template
                        # No wait_for_continue - has own menu
                        ;;
                    6)
                        # Help
                        show_motd_help
                        ;;
                    7|-1)
                        # Back (selected or ESC)
                        break
                        ;;
                esac
            done
            ;;
        1)
            # Configuration submenu (now includes SSH)
            while true; do
                choose_menu "ğŸ–¥ï¸  Configuration" \
                    "ğŸ“‹ Manage Hosts|Add, edit, delete SSH hosts" \
                    "ğŸ”‘ Distribute SSH Key|Copy key to all hosts" \
                    "ğŸ”“ Cleanup Host Keys|Remove stale known_hosts entries" \
                    "âš™ï¸  Settings|Domain suffix & IP detection" \
                    "ğŸ—‘ï¸  Uninstall|Remove homelab-tools" \
                    "HELP" "BACK"
                submenu_result="$HLT_MENU_RESULT"

                case "$submenu_result" in
                    0)
                        # Edit Hosts
                        clear
                        edit-hosts
                        # No wait_for_continue - has own menu
                        ;;
                    1)
                        # Copy SSH Key
                        clear
                        copykey
                        echo ""
                        wait_for_continue
                        ;;
                    2)
                        # Cleanup Old Keys
                        clear
                        echo ""
                        if read_input "IP address or hostname" host && [[ -n "$host" ]]; then
                            cleanup-keys "$host"
                            echo ""
                            wait_for_continue
                        fi
                        ;;
                    3)
                        # Edit Settings
                        clear
                        edit-config
                        echo ""
                        wait_for_continue
                        ;;
                    4)
                        # Uninstall
                        clear
                        echo ""
                        echo -e "${YELLOW}${BOLD}âš ï¸  Uninstall Homelab Tools${RESET}"
                        echo ""
                        echo -e "This will remove homelab-tools from your system."
                        echo -e "Your templates and SSH config will be preserved."
                        echo ""
                        echo -e "${CYAN}Are you sure?${RESET}"
                        echo ""
                        echo -e "  ${GREEN}1${RESET}) Yes, uninstall"
                        echo -e "  ${YELLOW}2${RESET}) No, cancel"
                        echo ""
                        read -p "$(echo -e ${CYAN}Choice \(1/2\):${RESET} )" uninstall_choice
                        if [[ "$uninstall_choice" == "1" ]]; then
                            echo ""
                            if [[ -f "/opt/homelab-tools/uninstall.sh" ]]; then
                                /opt/homelab-tools/uninstall.sh
                            elif [[ -f "$SCRIPT_DIR/../uninstall.sh" ]]; then
                                "$SCRIPT_DIR/../uninstall.sh"
                            else
                                echo -e "${RED}âœ— Uninstall script not found${RESET}"
                                echo -e "  Run manually: ${GREEN}sudo rm -rf /opt/homelab-tools${RESET}"
                            fi
                            exit 0
                        fi
                        ;;
                    5)
                        # Help
                        show_config_help
                        ;;
                    6|-1)
                        # Back (selected or ESC)
                        break
                        ;;
                esac
            done
            ;;
        2)
            # Backup Management
            backup_management_menu
            ;;
        3)
            # Help
            show_detailed_help
            echo ""
            wait_for_continue
            ;;
        4|-1)
            # Quit (selected or ESC)
            echo -e "${GREEN}âœ“ Goodbye!${RESET}"
            exit 0
            ;;
        "IDDQD")
            # Easter egg
            clear
            echo ""
            echo -e "${RED}${BOLD}"
            cat << 'DOOMGUY'

            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—
            â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘
            â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘
            â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘
            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘
            â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•

DOOMGUY
            echo -e "${RESET}"
            echo -e "${GREEN}              ğŸ® ${BOLD}GOD MODE ACTIVATED${RESET}${GREEN} ğŸ®${RESET}"
            echo ""
            echo -e "${YELLOW}         Degreelessness Mode: ${BOLD}INVINCIBLE${RESET}"
            echo ""
            sleep 2
            ;;
    esac
done
