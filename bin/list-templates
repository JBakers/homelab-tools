#!/bin/bash
set -euo pipefail

# List all MOTD templates
# Author: J.Bakers
# Version: See VERSION file

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"
DEPLOY_LOG="$HOME/.local/share/homelab-tools/deploy-log"

show_help() {
    echo -e "${BOLD}${CYAN}list-templates - View all MOTD templates${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  list-templates [OPTIONS]"
    echo ""
    echo -e "${BOLD}OPTIONS:${RESET}"
    echo "  -s, --status    Show deployment status for each template"
    echo "  -v, --view      Interactive mode: select and preview templates"
    echo "  -h, --help      Show this help message"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Shows an overview of all generated MOTD templates"
    echo ""
    echo -e "${BOLD}STATUS INDICATORS:${RESET}"
    echo "  ğŸŸ¢ deployed   Template has been deployed to host"
    echo "  ğŸŸ¡ ready      Template generated but not deployed"
    echo "  ğŸ”´ stale      Host changed since last deploy"
    echo ""
    echo -e "${BOLD}EXAMPLE:${RESET}"
    echo -e "  ${GREEN}list-templates${RESET}         # List all templates"
    echo -e "  ${GREEN}list-templates -s${RESET}      # List with deployment status"
    echo ""
}

# Parse arguments
SHOW_STATUS=false
INTERACTIVE_VIEW=false
while [[ $# -gt 0 ]]; do
    case "$1" in
        -s|--status)
            SHOW_STATUS=true
            shift
            ;;
        -v|--view)
            INTERACTIVE_VIEW=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${RESET}"
            show_help
            exit 1
            ;;
    esac
done

echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘         ğŸ“‹ MOTD Templates                                 â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

if [[ ! -d "$TEMPLATES_DIR" ]]; then
    echo -e "${YELLOW}âš  Templates directory does not exist${RESET}"
    echo -e "  Expected: ${CYAN}$TEMPLATES_DIR${RESET}"
    echo ""
    echo -e "  Generate a template first:"
    echo -e "  ${GREEN}generate-motd <service>${RESET}"
    exit 0
fi

# Count templates
template_count=$(find "$TEMPLATES_DIR" -maxdepth 1 -name "*.sh" -type f 2>/dev/null | wc -l)

if [[ $template_count -eq 0 ]]; then
    echo -e "${YELLOW}âš  No templates found${RESET}"
    echo -e "  Directory: ${CYAN}$TEMPLATES_DIR${RESET}"
    echo ""
    echo -e "  Generate a template:"
    echo -e "  ${GREEN}generate-motd <service>${RESET}"
    exit 0
fi

echo -e "${BOLD}Location:${RESET} ${CYAN}$TEMPLATES_DIR${RESET}"
echo -e "${BOLD}Count:${RESET}    ${GREEN}$template_count${RESET} template(s)"
echo ""

if [[ "$SHOW_STATUS" == "true" ]]; then
    echo -e "${BOLD}${CYAN}Template              Modified              Size    Status${RESET}"
    echo -e "${BOLD}${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
else
    echo -e "${BOLD}${CYAN}Template                Modified                   Size${RESET}"
    echo -e "${BOLD}${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
fi

# Get deployment status from log
get_deploy_status() {
    local service="$1"
    local template_modified="$2"
    
    if [[ ! -f "$DEPLOY_LOG" ]]; then
        echo "ready"
        return
    fi
    
    # Check if service was deployed (format: timestamp|service|host|status)
    local deploy_entry
    deploy_entry=$(grep "^[^|]*|${service}|" "$DEPLOY_LOG" 2>/dev/null | tail -1)
    
    if [[ -z "$deploy_entry" ]]; then
        echo "ready"
        return
    fi
    
    local deploy_time
    deploy_time=$(echo "$deploy_entry" | cut -d'|' -f1)
    
    # Compare timestamps: if template is newer than deploy, it's stale
    if [[ "$template_modified" > "$deploy_time" ]]; then
        echo "stale"
    else
        echo "deployed"
    fi
}

# List templates
find "$TEMPLATES_DIR" -maxdepth 1 -name "*.sh" -type f | sort | while read -r template; do
    name=$(basename "$template")
    service="${name%.sh}"
    modified=$(stat -c '%y' "$template" 2>/dev/null | cut -d' ' -f1,2 | cut -d: -f1-2)
    modified_epoch=$(stat -c '%Y' "$template" 2>/dev/null)
    size=$(du -h "$template" | cut -f1)
    
    if [[ "$SHOW_STATUS" == "true" ]]; then
        status=$(get_deploy_status "$service" "$modified_epoch")
        case "$status" in
            deployed)
                status_icon="ğŸŸ¢ deployed"
                ;;
            stale)
                status_icon="ğŸ”´ stale"
                ;;
            *)
                status_icon="ğŸŸ¡ ready"
                ;;
        esac
        printf "${GREEN}%-20s${RESET}  ${CYAN}%-20s${RESET}  ${YELLOW}%6s${RESET}  %s\n" "$name" "$modified" "$size" "$status_icon"
    else
        printf "${GREEN}%-24s${RESET}${CYAN}%s${RESET}  ${YELLOW}%6s${RESET}\n" "$name" "$modified" "$size"
    fi
done

echo ""

# Interactive view mode
if [[ "$INTERACTIVE_VIEW" == "true" ]]; then
    # Build template array
    mapfile -t templates < <(find "$TEMPLATES_DIR" -maxdepth 1 -name "*.sh" -type f | sort)
    
    if [[ ${#templates[@]} -eq 0 ]]; then
        echo -e "${YELLOW}No templates to preview${RESET}"
        exit 0
    fi
    
    # Build menu options
    menu_options=()
    for template in "${templates[@]}"; do
        name=$(basename "$template")
        service="${name%.sh}"
        menu_options+=("$service|Preview MOTD template")
    done
    menu_options+=("QUIT")
    
    # Load menu helper
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
    source "$LIB_DIR/menu-helpers.sh"
    
    while true; do
        choose_menu "ğŸ“‹ Select Template to Preview" "${menu_options[@]}"
        selection=$MENU_RESULT
        
        if [[ $selection -eq -1 ]] || [[ $selection -eq $((${#menu_options[@]} - 1)) ]]; then
            break
        fi
        
        # Show template preview
        selected_template="${templates[$selection]}"
        service=$(basename "$selected_template" .sh)
        
        clear
        echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo -e "â•‘         ğŸ“„ MOTD Preview: ${service}${RESET}${BOLD}${CYAN}"
        printf "â•‘%-58sâ•‘\n" ""
        echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        
        # Execute the template to show the MOTD
        bash "$selected_template"
        
        echo ""
        echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
        echo ""
        read -rp "$(echo -e "${CYAN}Press Enter to continue...${RESET}")"
        clear
    done
else
    echo -e "${YELLOW}Tip:${RESET} View a template with:"
    echo -e "  ${GREEN}cat $TEMPLATES_DIR/<name>.sh${RESET}"
    echo -e "  ${GREEN}list-templates -v${RESET} for interactive preview"
    echo ""
fi
