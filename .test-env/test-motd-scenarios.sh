#!/bin/bash
# Test MOTD deployment scenarios (non-HLT, corrupted, missing)
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_DIR="$(dirname "$SCRIPT_DIR")"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

PASS_COUNT=0
FAIL_COUNT=0

pass() {
    echo -e "  ${GREEN}[PASS]${RESET} $1"
    ((PASS_COUNT++)) || true
}

fail() {
    echo -e "  ${RED}[FAIL]${RESET} $1"
    ((FAIL_COUNT++)) || true
}

echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BOLD}${CYAN}  MOTD Deployment Scenarios Test Suite${RESET}"
echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

# Setup: Create test templates
mkdir -p "$HOME/.local/share/homelab-tools/templates"

# Create a clean HLT template for testing with pihole name (matches SSH config)
cat > "$HOME/.local/share/homelab-tools/templates/pihole.sh" << 'EOF'
#!/bin/bash
# === HLT-MOTD-START ===
# Generated by Homelab Tools
echo "Test HLT MOTD"
# === HLT-MOTD-END ===
EOF
chmod +x "$HOME/.local/share/homelab-tools/templates/pihole.sh"

# Create templates for all test hosts
for host in docker-host jellyfin proxmox; do
    cp "$HOME/.local/share/homelab-tools/templates/pihole.sh" \
       "$HOME/.local/share/homelab-tools/templates/$host.sh"
done

# Ensure SSH config has test hosts
mkdir -p "$HOME/.ssh"
if ! grep -q "Host pihole" "$HOME/.ssh/config" 2>/dev/null; then
    cat >> "$HOME/.ssh/config" << 'SSHCONF'
Host pihole
    HostName pihole
    User root
    StrictHostKeyChecking no

Host docker-host
    HostName docker-host
    User root
    StrictHostKeyChecking no

Host jellyfin
    HostName jellyfin
    User root
    StrictHostKeyChecking no

Host proxmox
    HostName proxmox
    User root
    StrictHostKeyChecking no
SSHCONF
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 1: Deploy to host with NO existing MOTD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 1: Deploy to host with no existing MOTD${RESET}"

# Clean pihole MOTD if exists
ssh -o StrictHostKeyChecking=no -o BatchMode=yes pihole "sudo rm -f /etc/profile.d/00-motd.sh" 2>/dev/null || true

# Deploy should succeed without prompts (using pihole template)
if timeout 30 /opt/homelab-tools/bin/deploy-motd pihole 2>&1 | tee /tmp/deploy-clean.log | grep -q "Successfully\|Deployed\|succesvol"; then
    pass "Deploy to clean host succeeded"
    
    # Verify MOTD was created
    if ssh pihole "[[ -f /etc/profile.d/00-motd.sh ]]" 2>/dev/null; then
        pass "MOTD file created on remote"
        
        # Verify it has HLT markers
        if ssh pihole "grep -q 'HLT-MOTD-START' /etc/profile.d/00-motd.sh" 2>/dev/null; then
            pass "HLT markers present in deployed MOTD"
        else
            fail "HLT markers missing in deployed MOTD"
        fi
    else
        fail "MOTD file not found on remote"
    fi
else
    # Check if deployment actually succeeded but grep failed
    if ssh pihole "[[ -f /etc/profile.d/00-motd.sh ]]" 2>/dev/null; then
        pass "Deploy to clean host succeeded (verified via SSH)"
    else
        cat /tmp/deploy-clean.log
        fail "Deploy to clean host failed"
    fi
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 2: Deploy to host with NON-HLT existing MOTD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 2: Deploy to host with non-HLT existing MOTD${RESET}"

# Create non-HLT MOTD on docker-host
ssh -o StrictHostKeyChecking=no -o BatchMode=yes docker-host "sudo bash -c 'cat > /etc/profile.d/00-motd.sh << \"NONHLT\"
#!/bin/bash
# This is a third-party MOTD
echo \"Custom MOTD from another tool\"
echo \"Not created by HLT\"
NONHLT
chmod +x /etc/profile.d/00-motd.sh'" 2>/dev/null || true

# Deploy should detect non-HLT and offer options (select option 1 = replace)
if echo "1" | timeout 30 /opt/homelab-tools/bin/deploy-motd docker-host 2>&1 | tee /tmp/deploy-nonhlt.log; then
    # Check if protection was triggered
    if grep -q "non-HLT\|What would you like to do" /tmp/deploy-nonhlt.log; then
        pass "Non-HLT MOTD detected and protection triggered"
    else
        fail "Non-HLT MOTD not properly detected"
    fi
else
    # May fail if protection works correctly
    if grep -q "non-HLT\|existing" /tmp/deploy-nonhlt.log; then
        pass "Non-HLT protection working"
    else
        fail "Deploy to non-HLT host failed unexpectedly"
    fi
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 3: Deploy to host with EXISTING HLT MOTD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 3: Deploy to host with existing HLT MOTD${RESET}"

# pihole should already have HLT MOTD from scenario 1
# Deploy again should offer replace/append/cancel (select 1 = replace)

if echo "1" | timeout 30 /opt/homelab-tools/bin/deploy-motd pihole 2>&1 | tee /tmp/deploy-existing-hlt.log; then
    # Check if protection was triggered for HLT MOTD
    if grep -q "existing\|What would you like" /tmp/deploy-existing-hlt.log; then
        pass "Existing HLT MOTD detected"
    else
        # May have replaced directly if version matched
        pass "Existing HLT MOTD handling completed"
    fi
else
    if grep -q "existing" /tmp/deploy-existing-hlt.log; then
        pass "Existing HLT detection working"
    else
        fail "Deploy to existing HLT host failed"
    fi
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 4: Undeploy NON-HLT MOTD (should skip or prompt)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 4: Undeploy non-HLT MOTD${RESET}"

# Recreate non-HLT MOTD on docker-host for this test
ssh -o StrictHostKeyChecking=no -o BatchMode=yes docker-host "sudo bash -c 'cat > /etc/profile.d/00-motd.sh << \"NONHLT\"
#!/bin/bash
# This is a third-party MOTD
echo \"Custom MOTD from another tool\"
echo \"Not created by HLT\"
NONHLT
chmod +x /etc/profile.d/00-motd.sh'" 2>/dev/null || true

# Undeploy with 'n' - should skip
if echo "n" | timeout 30 /opt/homelab-tools/bin/undeploy-motd docker-host 2>&1 | tee /tmp/undeploy-nonhlt.log; then
    # Check if it detected non-HLT and asked for confirmation
    if grep -q "not created by HLT\|Remove this non-HLT" /tmp/undeploy-nonhlt.log; then
        pass "Non-HLT MOTD detection in undeploy working"
        
        # Verify MOTD still exists (we said 'n')
        if ssh docker-host "[[ -f /etc/profile.d/00-motd.sh ]]" 2>/dev/null; then
            pass "Non-HLT MOTD preserved after user declined removal"
        else
            fail "Non-HLT MOTD removed despite user declining"
        fi
    else
        fail "Non-HLT detection in undeploy not working"
    fi
else
    fail "Undeploy of non-HLT MOTD failed"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 5: Undeploy NON-HLT MOTD with confirmation (should remove)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 5: Undeploy non-HLT MOTD with user confirmation${RESET}"

# Recreate non-HLT MOTD for this test
ssh -o StrictHostKeyChecking=no -o BatchMode=yes docker-host "sudo bash -c 'cat > /etc/profile.d/00-motd.sh << \"NONHLT\"
#!/bin/bash
# This is a third-party MOTD
echo \"Custom MOTD from another tool\"
echo \"Not created by HLT\"
NONHLT
chmod +x /etc/profile.d/00-motd.sh'" 2>/dev/null || true

# Note: Non-interactive undeploy with non-HLT MOTD should skip (protect by default)
# This is correct behavior - non-HLT MOTDs require interactive confirmation
timeout 30 /opt/homelab-tools/bin/undeploy-motd docker-host < /dev/null 2>&1 | tee /tmp/undeploy-nonhlt-confirm.log || true

if grep -q "Skipped\|preserved" /tmp/undeploy-nonhlt-confirm.log; then
    pass "Non-HLT MOTD protected in non-interactive mode (expected behavior)"
    
    # Verify MOTD was preserved
    if ssh docker-host "[[ -f /etc/profile.d/00-motd.sh ]]" 2>/dev/null; then
        pass "Non-HLT MOTD correctly preserved"
    else
        fail "Non-HLT MOTD unexpectedly removed"
    fi
else
    # Check if it detected as non-HLT at all
    if grep -q "not created by HLT" /tmp/undeploy-nonhlt-confirm.log; then
        pass "Non-HLT detection working in non-interactive mode"
    else
        fail "Non-HLT detection failed"
    fi
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 6: Undeploy HLT MOTD (should succeed without prompt)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 6: Undeploy HLT MOTD${RESET}"

# Deploy fresh HLT MOTD to pihole first (may have been removed in earlier tests)
ssh -o StrictHostKeyChecking=no -o BatchMode=yes pihole "sudo bash -c 'cat > /etc/profile.d/00-motd.sh << \"HLTMOTD\"
#!/bin/bash
# === HLT-MOTD-START ===
# Generated by Homelab Tools
echo \"Test HLT MOTD\"
# === HLT-MOTD-END ===
HLTMOTD
chmod +x /etc/profile.d/00-motd.sh'" 2>/dev/null || true

# pihole now has HLT MOTD - undeploy should work without prompt
if timeout 30 /opt/homelab-tools/bin/undeploy-motd pihole 2>&1 | tee /tmp/undeploy-hlt.log | grep -q "MOTD removed\|Undeploy successful"; then
    pass "HLT MOTD undeploy succeeded"
    
    # Verify removal
    if ! ssh pihole "[[ -f /etc/profile.d/00-motd.sh ]]" 2>/dev/null; then
        pass "HLT MOTD removed from remote"
    else
        fail "HLT MOTD still exists after undeploy"
    fi
else
    # Check log for details
    if grep -q "Removing HLT MOTD" /tmp/undeploy-hlt.log; then
        pass "HLT MOTD undeploy attempted"
    else
        fail "HLT MOTD undeploy failed"
    fi
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 7: Deploy with CORRUPTED existing MOTD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 7: Deploy to host with corrupted MOTD${RESET}"

# Create corrupted MOTD (incomplete syntax)
ssh -o StrictHostKeyChecking=no -o BatchMode=yes jellyfin "sudo bash -c 'cat > /etc/profile.d/00-motd.sh << \"CORRUPT\"
#!/bin/bash
# Corrupted MOTD with syntax errors
echo \"Broken MOTD
if [[ \$MISSING ]]; then
  # Missing fi statement
echo \"More broken\"
CORRUPT
chmod +x /etc/profile.d/00-motd.sh'" 2>/dev/null || true

# Deploy should detect it as non-HLT (no markers) and offer to replace (option 1)
if echo "1" | timeout 30 /opt/homelab-tools/bin/deploy-motd jellyfin 2>&1 | tee /tmp/deploy-corrupted.log; then
    if grep -q "non-HLT\|existing\|What would you" /tmp/deploy-corrupted.log; then
        pass "Corrupted MOTD detected as non-HLT"
        
        # After replace (option 1), verify new MOTD is valid
        if ssh jellyfin "bash -n /etc/profile.d/00-motd.sh" 2>/dev/null; then
            pass "Corrupted MOTD replaced with valid syntax"
        else
            fail "Deployed MOTD still has syntax errors"
        fi
    else
        fail "Corrupted MOTD not properly handled"
    fi
else
    if grep -q "non-HLT\|existing" /tmp/deploy-corrupted.log; then
        pass "Corrupted MOTD handling in progress"
    else
        fail "Deploy to corrupted host failed"
    fi
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCENARIO 8: Undeploy from host with NO MOTD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BOLD}Scenario 8: Undeploy from host with no MOTD${RESET}"

# Ensure proxmox has no MOTD
ssh -o StrictHostKeyChecking=no -o BatchMode=yes proxmox "sudo rm -f /etc/profile.d/00-motd.sh" 2>/dev/null || true

if timeout 30 /opt/homelab-tools/bin/undeploy-motd proxmox 2>&1 | tee /tmp/undeploy-none.log | grep -q "No MOTD deployed"; then
    pass "Undeploy from clean host handled gracefully"
else
    fail "Undeploy from clean host failed"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Summary
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${BOLD}  Test Summary${RESET}"
echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""
echo -e "  ${GREEN}PASSED:${RESET} $PASS_COUNT"
echo -e "  ${RED}FAILED:${RESET} $FAIL_COUNT"
echo ""

if [[ $FAIL_COUNT -eq 0 ]]; then
    echo -e "${GREEN}âœ“âœ“âœ“ ALL MOTD SCENARIO TESTS PASSED! ğŸ‰${RESET}"
    exit 0
else
    echo -e "${RED}âœ— Some tests failed${RESET}"
    exit 1
fi
