#!/bin/bash
set -euo pipefail

# Undeploy MOTD from remote host
# Author: J.Bakers
# Version: See VERSION file

# Colors
CYAN='\033[0;96m'
GREEN='\033[0;92m'
YELLOW='\033[0;93m'
RED='\033[0;95m'
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'

show_help() {
    echo -e "${BOLD}${CYAN}undeploy-motd - Remove MOTD from remote host${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  undeploy-motd <service-name>"
    echo "  undeploy-motd --all"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Removes deployed MOTD from remote host(s)."
    echo "  The script:"
    echo "  1. Connects to the remote host via SSH"
    echo "  2. Removes /etc/profile.d/00-motd.sh"
    echo "  3. Restores original /etc/motd if backup exists"
    echo ""
    echo -e "${BOLD}OPTIONS:${RESET}"
    echo "  <service-name>  Remove MOTD from specific host"
    echo "  --all           Remove MOTDs from all hosts in SSH config"
    echo ""
    echo -e "${BOLD}EXAMPLES:${RESET}"
    echo -e "  ${GREEN}undeploy-motd pihole${RESET}"
    echo -e "  ${GREEN}undeploy-motd --all${RESET}"
    echo ""
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

undeploy_single() {
    local service="$1"
    
    echo -e "${CYAN}â†’${RESET} Checking ${BOLD}$service${RESET}..."
    
    # Test SSH connection with timeout
    if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "$service" "echo 2>&1" &>/dev/null; then
        echo -e "${RED}  âœ—${RESET} Cannot connect to $service (timeout after 5s)"
        return 1
    fi
    
    # Check if MOTD exists on remote
    if ! ssh "$service" -- "[[ -f /etc/profile.d/00-motd.sh ]]" 2>/dev/null; then
        echo -e "${YELLOW}  â†’${RESET} No MOTD deployed on $service"
        return 0
    fi
    
    # Check if it's an HLT MOTD
    local remote_motd
    remote_motd=$(ssh "$service" -- "cat /etc/profile.d/00-motd.sh 2>/dev/null" || true)
    
    if [[ "$remote_motd" != *"HLT-MOTD-START"* ]]; then
        echo -e "${YELLOW}  âš ${RESET} MOTD exists but was not created by HLT"
        echo -e "${DIM}     (no HLT-MOTD-START marker found)${RESET}"
        echo -e "${YELLOW}     Skipping to protect existing configuration${RESET}"
        return 0
    fi
    
    # Check if there's content outside HLT markers (appended mode)
    if [[ "$remote_motd" == *"# === Appended by HLT ==="* ]]; then
        echo -e "${YELLOW}  â†’${RESET} Found appended HLT MOTD, removing only HLT section..."
        # Remove only the HLT section (from marker to end)
        ssh "$service" -- "sudo sed -i '/# === Appended by HLT ===/,\$d' /etc/profile.d/00-motd.sh" 2>/dev/null
        echo -e "${GREEN}  âœ“${RESET} HLT section removed (original MOTD preserved)"
        return 0
    fi
    
    # Full HLT MOTD - remove entirely
    echo -e "${CYAN}â†’${RESET} Removing HLT MOTD from ${BOLD}$service${RESET}..."
    if ssh "$service" -- "sudo rm -f /etc/profile.d/00-motd.sh" 2>/dev/null; then
        echo -e "${GREEN}  âœ“${RESET} MOTD removed"
    else
        echo -e "${RED}  âœ—${RESET} Failed to remove MOTD"
        return 1
    fi
    
    # Restore backup if exists
    if ssh "$service" -- "[[ -f /etc/profile.d/00-motd.sh.backup ]]" 2>/dev/null; then
        if ssh "$service" -- "sudo mv /etc/profile.d/00-motd.sh.backup /etc/profile.d/00-motd.sh" 2>/dev/null; then
            echo -e "${GREEN}  âœ“${RESET} Original MOTD restored from backup"
        fi
    fi
    
    return 0
}

undeploy_all() {
    local ssh_config="$HOME/.ssh/config"
    
    if [[ ! -f "$ssh_config" ]]; then
        echo -e "${RED}âœ— Error: No SSH config found${RESET}"
        exit 1
    fi
    
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ—‘ï¸  Bulk MOTD Undeploy                           â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    # Get all hosts from SSH config
    local hosts
    hosts=$(grep "^Host " "$ssh_config" | awk '{print $2}' | grep -v '\*' | sort -u)
    local host_count
    host_count=$(echo "$hosts" | wc -w)
    
    if [[ $host_count -eq 0 ]]; then
        echo -e "${YELLOW}â†’${RESET} No hosts found in SSH config"
        exit 0
    fi
    
    echo -e "${CYAN}Found $host_count host(s)${RESET}"
    echo ""
    read -rp "$(echo -e "${YELLOW}Undeploy MOTDs from all hosts? (y/N): ${RESET}")" confirm
    confirm=${confirm:-n}
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Cancelled${RESET}"
        exit 0
    fi
    
    echo ""
    local success=0
    local failed=0
    
    # Temporarily disable exit-on-error for the loop
    set +e
    
    for hostname in $hosts; do
        if undeploy_single "$hostname"; then
            ((success++))
        else
            ((failed++))
        fi
        echo ""
    done
    
    # Re-enable exit-on-error
    set -e
    
    echo -e "${BOLD}Summary:${RESET}"
    echo -e "  ${GREEN}âœ“${RESET} Success: $success"
    if [[ $failed -gt 0 ]]; then
        echo -e "  ${RED}âœ—${RESET} Failed: $failed"
    fi
}

# Main
SERVICE="${1:-}"

if [[ -z "$SERVICE" ]]; then
    echo -e "${RED}âœ— Error: No service name provided${RESET}"
    echo -e "  Usage: ${GREEN}undeploy-motd <service-name>${RESET}"
    echo -e "  Or: ${GREEN}undeploy-motd --all${RESET}"
    echo -e "  Help: ${CYAN}undeploy-motd --help${RESET}"
    exit 1
fi

# Validate service name (unless --all)
if [[ "$SERVICE" != "--all" ]]; then
    if [[ ! "$SERVICE" =~ ^[a-zA-Z0-9._-]+$ ]]; then
        echo -e "${RED}âœ— Error: Invalid service name${RESET}"
        echo -e "  Only letters, numbers, dots, underscores and dashes allowed"
        exit 1
    fi
fi

if [[ "$SERVICE" == "--all" ]]; then
    undeploy_all
else
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ—‘ï¸  MOTD Undeploy                                â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}Service: ${GREEN}$SERVICE${RESET}"
    echo ""
    
    if undeploy_single "$SERVICE"; then
        echo ""
        echo -e "${GREEN}âœ“ Undeploy successful${RESET}"
    else
        echo ""
        echo -e "${RED}âœ— Undeploy failed${RESET}"
        exit 1
    fi
fi
