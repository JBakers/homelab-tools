#!/bin/bash
set -euo pipefail

# Generate MOTD template for homelab services
# Author: J.Bakers
# Version: See VERSION file

# Colors
CYAN='\033[0;36m'
# Load shared constants (optional, used for detection rules)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
if [[ -f "$LIB_DIR/constants.sh" ]]; then
    # shellcheck source=/dev/null
    source "$LIB_DIR/constants.sh"
fi
# Source menu helpers for choose_menu function
if [[ -f "$LIB_DIR/menu-helpers.sh" ]]; then
    # shellcheck source=/dev/null
    source "$LIB_DIR/menu-helpers.sh"
fi
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"
CONFIG_FILE="/opt/homelab-tools/config.sh"

# Systems that don't support MOTD (appliances, Docker, non-Linux)
UNSUPPORTED_SYSTEMS=(
    "homeassistant" "hass" "ha"           # Home Assistant (Docker)
    "truenas"                              # TrueNAS (FreeBSD appliance)
    "pfsense" "opnsense"                   # Firewall appliances
    "windows" "win"                        # Windows systems
    "unraid"                               # Unraid (different MOTD)
    "synology" "nas"                       # Synology NAS
    "qnap"                                 # QNAP NAS
)

# Load config
if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck source=/dev/null
    source "$CONFIG_FILE"
else
    # Defaults
    export DOMAIN_SUFFIX=""
    export IP_METHOD="ip"
fi

show_help() {
    echo -e "${BOLD}${CYAN}generate-motd - Generate MOTD template${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  generate-motd <service-name>"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Generates a dynamic MOTD template for a homelab service."
    echo "  Template is saved in ~/homelab-tools/templates/"
    echo ""
    echo -e "${BOLD}INTERACTIVE:${RESET}"
    echo "  The script will ask for:"
    echo "  - Service name (e.g., Pi-hole, Home Assistant)"
    echo "  - Description (e.g., Media Server)"
    echo "  - Whether there's a Web UI (y/n)"
    echo "  - Port number (if Web UI)"
    echo ""
    echo -e "${BOLD}EXAMPLE:${RESET}"
    echo -e "  ${GREEN}generate-motd jellyfin${RESET}"
    echo ""
    echo "  The script will then ask:"
    echo "    Service name: Jellyfin"
    echo "    Description: Media Server"
    echo "    Web UI? (y/n): y"
    echo "    Port: 8096"
    echo ""
    echo -e "${BOLD}NOTE:${RESET}"
    echo -e "  The MOTD is ${YELLOW}dynamically${RESET} generated on each login, so"
    echo "  information like uptime and versions are always current."
    echo ""
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

SERVICE=${1:-}

if [[ -z "$SERVICE" ]]; then
    echo -e "${RED}âœ— Error: No service name provided${RESET}"
    echo -e "  Usage: ${GREEN}generate-motd <service-name>${RESET}"
    echo -e "  Example: ${GREEN}generate-motd pihole${RESET}"
    echo -e "  Or: ${CYAN}generate-motd --help${RESET} for more information"
    exit 1
fi

# Validate service name to prevent command injection
if [[ ! "$SERVICE" =~ ^[a-zA-Z0-9._-]+$ ]]; then
    echo -e "${RED}âœ— Error: Invalid service name${RESET}"
    echo -e "  Only letters, digits, dots, underscores and hyphens are allowed"
    echo -e "  Example: ${GREEN}generate-motd pihole${RESET}"
    exit 1
fi

# Non-interactive mode: if stdin is piped, create a minimal template and exit
if [[ ! -t 0 ]]; then
    mkdir -p "$TEMPLATES_DIR"
    template_path="$TEMPLATES_DIR/$SERVICE.sh"
    webui_flag="n"
    webui_port=""
    # Read two lines from stdin if provided: y/n and port/url
    if IFS= read -r webui_flag_input; then
        webui_flag="$webui_flag_input"
    fi
    if IFS= read -r webui_port_input; then
        webui_port="$webui_port_input"
    fi
    # Build optional web URL
    web_url=""
    if [[ "$webui_flag" =~ ^[Yy]$ ]]; then
        if [[ -n "$webui_port" ]]; then
            web_url="http://${SERVICE}${DOMAIN_SUFFIX}:${webui_port}"
        else
            web_url="http://${SERVICE}${DOMAIN_SUFFIX}"
        fi
    fi
    cat > "$template_path" << 'EOF'
#!/bin/bash
# === HLT-MOTD-START ===
# Generated by Homelab Tools (https://github.com/JBakers/homelab-tools)
# Do not edit between HLT-MOTD-START and HLT-MOTD-END markers
# MOTD - Generated minimal template (non-interactive)

NC='\033[0m'
CYAN='\033[0;96m'
GREEN='\033[0;92m'
YELLOW='\033[1;33m'

echo -e "${YELLOW}========================================${NC}"
echo -e "${CYAN} Homelab Service MOTD${NC}"
echo -e "${YELLOW}========================================${NC}"
echo -e "  ${YELLOW}Service:${NC}      ${GREEN}SERVICE_PLACEHOLDER${NC}"
echo -e "  ${YELLOW}Hostname:${NC}     ${CYAN}SERVICE_PLACEHOLDERDOMAIN_PLACEHOLDER${NC}"
EOF
    # Append web UI if available (avoid expansion now; use placeholder)
    if [[ -n "$web_url" ]]; then
        echo 'echo -e "  ${YELLOW}ðŸ”— Web UI:${NC}      ${CYAN}WEB_URL_PLACEHOLDER${NC}"' >> "$template_path"
        sed -i "s|WEB_URL_PLACEHOLDER|$web_url|" "$template_path"
    fi
    # Add closing marker
    echo '# === HLT-MOTD-END ===' >> "$template_path"
    # Replace placeholders
    sed -i "s/SERVICE_PLACEHOLDER/$SERVICE/g" "$template_path"
    sed -i "s|DOMAIN_PLACEHOLDER|$DOMAIN_SUFFIX|g" "$template_path"
    chmod +x "$template_path"
    echo -e "${GREEN}âœ“${RESET} Template created: ${CYAN}$template_path${RESET}"
    exit 0
fi

# Check if system is unsupported
SERVICE_LOWER=$(echo "$SERVICE" | tr '[:upper:]' '[:lower:]')
for unsupported in "${UNSUPPORTED_SYSTEMS[@]}"; do
    if [[ "$SERVICE_LOWER" == "$unsupported" ]]; then
        echo -e "${YELLOW}âš ${RESET} ${BOLD}$SERVICE${RESET} doesn't support MOTD"
        echo ""
        echo -e "${BOLD}Reason:${RESET}"
        case "$unsupported" in
            homeassistant|hass|ha)
                echo -e "  Home Assistant runs in Docker without system access"
                echo -e "  Use the web UI: ${CYAN}http://${SERVICE}${DOMAIN_SUFFIX}:8123${RESET}"
                ;;
            truenas)
                echo -e "  TrueNAS is a FreeBSD appliance (not Linux)"
                echo -e "  Use the web UI: ${CYAN}https://${SERVICE}${DOMAIN_SUFFIX}${RESET}"
                ;;
            pfsense|opnsense)
                echo -e "  Firewall appliances don't support custom MOTD"
                echo -e "  Use the web UI: ${CYAN}https://${SERVICE}${DOMAIN_SUFFIX}${RESET}"
                ;;
            windows|win)
                echo -e "  Windows systems don't use MOTD"
                echo -e "  Use RDP to connect"
                ;;
            unraid)
                echo -e "  Unraid uses a different MOTD system"
                echo -e "  Use the web UI: ${CYAN}http://${SERVICE}${DOMAIN_SUFFIX}${RESET}"
                ;;
            synology|nas|qnap)
                echo -e "  NAS systems have proprietary operating systems"
                echo -e "  Use the web UI: ${CYAN}http://${SERVICE}${DOMAIN_SUFFIX}:5000${RESET}"
                ;;
        esac
        echo ""
        exit 0
    fi
done

mkdir -p "$TEMPLATES_DIR"

echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘         ðŸ“ MOTD Generator                                 â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""
echo -e "${BOLD}Service: ${GREEN}$SERVICE${RESET}"
echo ""

# Smart defaults op basis van hostname
service_name=""
description=""
has_webui="n"
webui_port=""

case "$SERVICE" in
    # Media Servers
    jellyfin*)
        number=$(echo "$SERVICE" | grep -o '[0-9]\+$' || true)
        service_name="Jellyfin${number:+ $number}"
        description="Media Server"
        has_webui="y"
        webui_port="8096"
        ;;
    plex*)
        number=$(echo "$SERVICE" | grep -o '[0-9]\+$' || true)
        service_name="Plex${number:+ $number}"
        description="Media Server"
        has_webui="y"
        webui_port="32400/web"
        ;;
    emby*)
        number=$(echo "$SERVICE" | grep -o '[0-9]\+$' || true)
        service_name="Emby${number:+ $number}"
        description="Media Server"
        has_webui="y"
        webui_port="8096"
        ;;
    
    # *arr Stack
    sonarr)
        service_name="Sonarr"
        description="TV Series Management"
        has_webui="y"
        webui_port="8989"
        ;;
    radarr)
        service_name="Radarr"
        description="Movie Management"
        has_webui="y"
        webui_port="7878"
        ;;
    lidarr)
        service_name="Lidarr"
        description="Music Management"
        has_webui="y"
        webui_port="8686"
        ;;
    readarr)
        service_name="Readarr"
        description="Book Management"
        has_webui="y"
        webui_port="8787"
        ;;
    prowlarr)
        service_name="Prowlarr"
        description="Indexer Manager"
        has_webui="y"
        webui_port="9696"
        ;;
    bazarr)
        service_name="Bazarr"
        description="Subtitle Management"
        has_webui="y"
        webui_port="6767"
        ;;
    
    # Download Clients
    sabnzbd)
        service_name="SABnzbd"
        description="Usenet Downloader"
        has_webui="y"
        webui_port="8080"
        ;;
    nzbget)
        service_name="NZBGet"
        description="Usenet Downloader"
        has_webui="y"
        webui_port="6789"
        ;;
    transmission)
        service_name="Transmission"
        description="Torrent Client"
        has_webui="y"
        webui_port="9091"
        ;;
    qbittorrent)
        service_name="qBittorrent"
        description="Torrent Client"
        has_webui="y"
        webui_port="8080"
        ;;
    deluge)
        service_name="Deluge"
        description="Torrent Client"
        has_webui="y"
        webui_port="8112"
        ;;
    
    # Request Management
    overseerr)
        service_name="Overseerr"
        description="Request Management"
        has_webui="y"
        webui_port="5055"
        ;;
    ombi)
        service_name="Ombi"
        description="Request Management"
        has_webui="y"
        webui_port="3579"
        ;;
    
    # Network & DNS
    pihole*|pi-hole*)
        # Extract number if present (pihole2 -> 2)
        number=$(echo "$SERVICE" | grep -o '[0-9]\+$' || true)
        if [[ -n "$number" ]]; then
            service_name="Pi-hole $number"
        else
            service_name="Pi-hole"
        fi
        description="Network-wide Ad Blocking"
        has_webui="y"
        webui_port="80/admin"
        ;;
    adguard*)
        number=$(echo "$SERVICE" | grep -o '[0-9]\+$' || true)
        if [[ -n "$number" ]]; then
            service_name="AdGuard Home $number"
        else
            service_name="AdGuard Home"
        fi
        description="Network-wide Ad Blocking"
        has_webui="y"
        webui_port="3000"
        ;;
    unbound)
        service_name="Unbound"
        description="DNS Resolver"
        has_webui="n"
        ;;
    
    # Virtualization & Containers
    portainer)
        service_name="Portainer"
        description="Docker Management"
        has_webui="y"
        webui_port="9000"
        ;;
    proxmox)
        service_name="Proxmox"
        description="Virtualization Platform"
        has_webui="y"
        webui_port="8006"
        ;;
    pbs)
        service_name="PBS"
        description="Proxmox Backup Server"
        has_webui="y"
        webui_port="8007"
        ;;
    yacht)
        service_name="Yacht"
        description="Docker Management"
        has_webui="y"
        webui_port="8000"
        ;;

    # Home Automation
    nodered|node-red)
        service_name="Node-RED"
        description="Flow Programming"
        has_webui="y"
        webui_port="1880"
        ;;
    zigbee2mqtt|z2m)
        service_name="Zigbee2MQTT"
        description="Zigbee to MQTT Bridge"
        has_webui="y"
        webui_port="8080"
        ;;
    mosquitto|mqtt)
        service_name="Mosquitto"
        description="MQTT Broker"
        has_webui="n"
        ;;
    esphome)
        service_name="ESPHome"
        description="ESP Device Management"
        has_webui="y"
        webui_port="6052"
        ;;
    
    # Monitoring & Analytics
    frigate)
        service_name="Frigate"
        description="NVR with AI Detection"
        has_webui="y"
        webui_port="5000"
        ;;
    kuma|uptime*)
        service_name="Uptime Kuma"
        description="Status Monitoring"
        has_webui="y"
        webui_port="3001"
        ;;
    grafana)
        service_name="Grafana"
        description="Analytics & Monitoring"
        has_webui="y"
        webui_port="3000"
        ;;
    prometheus)
        service_name="Prometheus"
        description="Metrics Collection"
        has_webui="y"
        webui_port="9090"
        ;;
    influxdb)
        service_name="InfluxDB"
        description="Time Series Database"
        has_webui="y"
        webui_port="8086"
        ;;
    tautulli)
        service_name="Tautulli"
        description="Plex Monitoring"
        has_webui="y"
        webui_port="8181"
        ;;
    netdata)
        service_name="Netdata"
        description="Real-time Monitoring"
        has_webui="y"
        webui_port="19999"
        ;;
    glances)
        service_name="Glances"
        description="System Monitoring"
        has_webui="y"
        webui_port="61208"
        ;;
    
    # VPN & Network Tools
    wireguard|wg)
        service_name="WireGuard"
        description="VPN Server"
        has_webui="n"
        ;;
    openvpn)
        service_name="OpenVPN"
        description="VPN Server"
        has_webui="n"
        ;;
    nginx*)
        service_name="Nginx"
        description="Reverse Proxy"
        has_webui="n"
        ;;
    traefik)
        service_name="Traefik"
        description="Reverse Proxy"
        has_webui="y"
        webui_port="8080"
        ;;
    
    # File Management & Sync
    nextcloud)
        service_name="Nextcloud"
        description="File Sync & Share"
        has_webui="y"
        webui_port="443"
        ;;
    syncthing)
        service_name="Syncthing"
        description="File Synchronization"
        has_webui="y"
        webui_port="8384"
        ;;
    filebrowser)
        service_name="File Browser"
        description="Web File Manager"
        has_webui="y"
        webui_port="8080"
        ;;
    
    # Gaming
    minecraft|mc)
        service_name="Minecraft"
        description="Game Server"
        has_webui="n"
        ;;
    pocketmine|pmmp)
        service_name="PocketMine"
        description="Minecraft PE Server"
        has_webui="n"
        ;;
    powernukkitx|pnx)
        service_name="PowerNukkitX"
        description="Minecraft BE Server"
        has_webui="n"
        ;;
    
    # Cameras & Security
    motioneye)
        service_name="motionEye"
        description="Video Surveillance"
        has_webui="y"
        webui_port="8765"
        ;;
    zoneminder)
        service_name="ZoneMinder"
        description="Video Surveillance"
        has_webui="y"
        webui_port="80"
        ;;
    
    # Misc Services
    allsky)
        service_name="AllSky"
        description="All-Sky Camera"
        has_webui="y"
        webui_port="80"
        ;;
    emqx)
        service_name="EMQX"
        description="MQTT Broker"
        has_webui="y"
        webui_port="18083"
        ;;
    docker*)
        service_name="Docker"
        description="Container Host"
        has_webui="n"
        ;;
    test*|demo*)
        service_name="Test"
        description="Test Server"
        has_webui="n"
        ;;
    
    *)
        # Capitalize eerste letter voor onbekende services
        # Preserve numbers in service name (e.g., test1 â†’ Test 1)
        base_name=$(echo "$SERVICE" | sed 's/[0-9]*$//')
        service_name="$(echo "$base_name" | sed 's/\b\(.\)/\u\1/g')"
        
        # Add number if present
        if [[ "$SERVICE" =~ ([0-9]+)$ ]]; then
            num="${BASH_REMATCH[1]}"
            service_name="$service_name $num"
        fi
        
        description="Server"

        # Preserve numbers in service name for unknown services (e.g., myservice2 â†’ Myservice 2)
        # Only for default case - known services handle numbers in their case statements
        if [[ "$SERVICE" =~ ([0-9]+)$ ]]; then
            num="${BASH_REMATCH[1]}"
            # Remove number from service_name and add it back with space
            service_name="${service_name%$num} $num"
        fi
        ;;
esac

echo -e "${GREEN}âœ“${RESET} Auto-detected: ${CYAN}$service_name - $description${RESET}"
if [[ "$has_webui" == "y" ]]; then
    echo -e "${GREEN}âœ“${RESET} Web UI: ${CYAN}$webui_port${RESET}"
fi
echo ""

# Ask for confirmation or override (default = n = continue directly)
read -p "$(echo -e "${YELLOW}Customize? (y/N/q=cancel):${RESET} ")" customize
if [[ "$customize" == "q" || "$customize" == "Q" ]]; then
    echo -e "${YELLOW}Cancelled${RESET}"
    exit 0
fi
customize=${customize:-n}

if [[ "$customize" == "y" ]] || [[ "$customize" == "Y" ]]; then
    read -p "$(echo -e ${CYAN}Service name \(for ASCII art\) [${service_name}]:${RESET} )" custom_name
    [[ -n "$custom_name" ]] && service_name="$custom_name"
    
    read -p "$(echo -e ${CYAN}Description [${description}]:${RESET} )" custom_desc
    [[ -n "$custom_desc" ]] && description="$custom_desc"
    
    read -p "$(echo -e "${CYAN}Web UI? (y/n) [${has_webui}]:${RESET} ")" custom_webui
    [[ -n "$custom_webui" ]] && has_webui="$custom_webui"
    
    if [[ "$has_webui" == "y" ]]; then
        read -p "$(echo -e ${CYAN}Port or URL [${webui_port}]:${RESET} )" custom_port
        [[ -n "$custom_port" ]] && webui_port="$custom_port"
    fi
fi

echo ""
echo -e "${YELLOW}â†’${RESET} Choosing ASCII art style..."
echo ""

# Function to show ASCII preview
show_ascii_preview() {
    local text="$1"
    local font="$2"
    local filter="$3"
    
    if command -v toilet &> /dev/null; then
        if [[ -n "$filter" ]]; then
            toilet -f "$font" -F "$filter" "$text" 2>/dev/null
        else
            toilet -f "$font" "$text" 2>/dev/null
        fi
    elif command -v figlet &> /dev/null; then
        figlet "$text" 2>/dev/null
    else
        echo "=== $text ==="
    fi
}

# Show available styles
echo -e "${BOLD}Available MOTD styles:${RESET}"
echo ""

if command -v toilet &> /dev/null; then
    while true; do
        choose_menu "Choose MOTD Style" \
            "Clean & Functional|No ASCII - Clean & Informative" \
            "Rainbow Future|Colorful, modern" \
            "Rainbow Standard|Colorful, classic" \
            "Mono Future|Black & white, modern" \
            "Big Mono|Large, bold" \
            "Small/Smblock|Small, compact" \
            "PREVIEW|Show all styles"
        
        choice_idx=$MENU_RESULT
        
        # Check if cancelled
        if [[ $choice_idx -eq -1 ]]; then
            echo -e "${YELLOW}Cancelled${RESET}"
            exit 0
        fi
        
        # Handle preview (last option)
        if [[ $choice_idx -eq 6 ]]; then
            clear
            echo -e "${BOLD}${CYAN}ASCII Art Preview - \"$service_name\"${RESET}"
            echo ""

            echo -e "${CYAN}2) Rainbow Future:${RESET}"
            show_ascii_preview "$service_name" "future" "gay"
            echo ""

            echo -e "${CYAN}3) Rainbow Standard:${RESET}"
            show_ascii_preview "$service_name" "standard" "gay"
            echo ""

            echo -e "${CYAN}4) Mono Future:${RESET}"
            show_ascii_preview "$service_name" "future" ""
            echo ""

            echo -e "${CYAN}5) Big Mono:${RESET}"
            show_ascii_preview "$service_name" "bigmono9" ""
            echo ""

            echo -e "${CYAN}6) Small/Smblock:${RESET}"
            show_ascii_preview "$service_name" "smblock" ""
            echo ""

            read -p "$(echo -e ${GREEN}Press Enter to continue...${RESET} )"
            continue
        fi
        
        # Valid style selected (convert 0-based to 1-based for ASCII mapping)
        style_choice=$((choice_idx + 1))
        break
    done
else
    echo -e "${YELLOW}âš  Toilet not installed - ASCII art not available${RESET}"
    echo -e "  For ASCII art: ${GREEN}sudo apt install toilet toilet-fonts${RESET}"
    style_choice="1"
fi

# Determine font and filter based on choice
case "$style_choice" in
    1|"")
        # Clean & Functional - no ASCII art
        ascii_font="none"
        ascii_filter=""
        echo -e "${GREEN}âœ“${RESET} Selected: Clean & Functional (no ASCII)"
        ;;
    2)
        ascii_font="future"
        ascii_filter="gay"
        echo -e "${GREEN}âœ“${RESET} Selected: Rainbow Future"
        ;;
    3)
        ascii_font="standard"
        ascii_filter="gay"
        echo -e "${GREEN}âœ“${RESET} Selected: Rainbow Standard"
        ;;
    4)
        ascii_font="future"
        ascii_filter=""
        echo -e "${GREEN}âœ“${RESET} Selected: Mono Future"
        ;;
    5)
        ascii_font="bigmono9"
        ascii_filter=""
        echo -e "${GREEN}âœ“${RESET} Selected: Big Mono"
        ;;
    6)
        ascii_font="smblock"
        ascii_filter=""
        echo -e "${GREEN}âœ“${RESET} Selected: Small/Smblock"
        ;;
    *)
        # Default to clean functional
        ascii_font="none"
        ascii_filter=""
        echo -e "${YELLOW}âš ${RESET} Invalid choice, using Clean & Functional"
        ;;
esac

# Genereer ASCII art LOKAAL
rainbow_art=""
if [[ "$ascii_font" == "none" ]]; then
    # Clean & Functional - geen ASCII art, alleen service naam
    rainbow_art=""
elif [[ "$ascii_font" == "basic" ]]; then
    # Fallback: figlet of plain text
    if command -v figlet &> /dev/null; then
        rainbow_art=$(figlet -c "$service_name" 2>/dev/null)
    else
        rainbow_art=$(printf "%40s\n" "=== $service_name ===")
    fi
else
    # Gebruik gekozen toilet font/filter
    if [[ -n "$ascii_filter" ]]; then
        rainbow_art=$(toilet -f "$ascii_font" -F "$ascii_filter" "$service_name" 2>/dev/null)
    else
        rainbow_art=$(toilet -f "$ascii_font" "$service_name" 2>/dev/null)
    fi

    # Fallback if font doesn't work
    if [[ -z "$rainbow_art" ]]; then
        rainbow_art=$(toilet -f standard -F gay "$service_name" 2>/dev/null)
        echo -e "${YELLOW}âš ${RESET} Font not available, using standard"
    fi
fi

# Determine which version commands are needed
version_check=""
case "$SERVICE" in
    pihole)
        version_check="PIHOLE_VERSION=\$(sudo pihole -v 2>/dev/null | grep 'Pi-hole' | awk '{print \$3}')"
        ;;
    docker|portainer|jellyfin|sonarr|radarr|prowlarr|plex)
        version_check="DOCKER_VERSION=\$(docker --version 2>/dev/null | awk '{print \$3}' | tr -d ',')"
        ;;
    homeassistant|hass)
        version_check="HASS_VERSION=\$(docker exec homeassistant cat /config/.HA_VERSION 2>/dev/null)"
        ;;
esac

# Genereer de template - start met header en HLT marker
cat > "$TEMPLATES_DIR/$SERVICE.sh" << 'TEMPLATE_START'
#!/bin/bash
# === HLT-MOTD-START ===
# Generated by Homelab Tools (https://github.com/JBakers/homelab-tools)
# Do not edit between HLT-MOTD-START and HLT-MOTD-END markers
# MOTD
# Kleuren
CYAN='\033[0;96m'
GREEN='\033[0;92m'
YELLOW='\033[0;93m'
# BLUE removed - using CYAN instead
MAGENTA='\033[0;95m'
RED='\033[0;91m'
BOLD='\033[1m'
UNDERLINE='\033[4m'
NC='\033[0m'

# Get current information
HOSTNAME=$(hostname)

# Try hostname -I first (simple), fallback to ip route (reliable in containers)
IP_ADDRESS=$(hostname -I 2>/dev/null | awk '{print $1}')
if [[ -z "$IP_ADDRESS" ]]; then
    IP_ADDRESS=$(ip route get 1.1.1.1 2>/dev/null | awk '{print $7}')
fi
if [[ -z "$IP_ADDRESS" ]]; then
    IP_ADDRESS="N/A"
fi

UPTIME=$(uptime -p | sed 's/up //')

VERSION_CHECK_PLACEHOLDER
TEMPLATE_START

# Add ASCII art or clean header - depending on selection
if [[ "$ascii_font" == "none" ]]; then
    # Clean & Functional - geen ASCII art
    cat >> "$TEMPLATES_DIR/$SERVICE.sh" << 'TEMPLATE_CLEAN'

echo ""
echo -e "${CYAN}==========================================${NC}"
echo -e "  ${CYAN}${BOLD}SERVICE_NAME_PLACEHOLDER${NC}"
echo -e "  ${MAGENTA}DESCRIPTION_PLACEHOLDER${NC}"
echo -e "  ${MAGENTA}by J.Bakers${NC}"
echo -e "${CYAN}==========================================${NC}"
echo ""
echo -e "${GREEN}${BOLD}ðŸ“Š System Information:${NC}"
echo ""
echo -e "  ${YELLOW}ðŸ–¥ï¸  Hostname:${NC}    $HOSTNAME"
echo -e "  ${YELLOW}ðŸŒ IP Address:${NC}  $IP_ADDRESS"
echo -e "  ${YELLOW}â±ï¸  Uptime:${NC}      $UPTIME"
TEMPLATE_CLEAN
else
    # ASCII art versie
    cat >> "$TEMPLATES_DIR/$SERVICE.sh" << 'TEMPLATE_ASCII_START'

# ASCII Art (met lichte indent)
echo ""
while IFS= read -r line; do
    printf "     %s\n" "$line"
done << 'ASCII_ART'
TEMPLATE_ASCII_START

    # Add ASCII art as a heredoc block (preserves all ANSI codes)
    echo "$rainbow_art" >> "$TEMPLATES_DIR/$SERVICE.sh"

    # Sluit de ASCII art heredoc af en ga verder met de template
    cat >> "$TEMPLATES_DIR/$SERVICE.sh" << 'TEMPLATE_ASCII_MIDDLE'
ASCII_ART
echo ""
echo -e "        ${CYAN}DESCRIPTION_PLACEHOLDER${NC}"
echo -e "           ${MAGENTA}by J.Bakers${NC}"
echo ""
echo -e "${CYAN}==========================================${NC}"
printf "%7s" ""
echo -e "${GREEN}${BOLD}${UNDERLINE}ðŸ“Š System Information:${NC}"
echo ""
echo -e "  ${YELLOW}ðŸ–¥ï¸  Hostname:${NC}    $HOSTNAME"
echo -e "  ${YELLOW}ðŸŒ IP Address:${NC}  $IP_ADDRESS"
echo -e "  ${YELLOW}â±ï¸  Uptime:${NC}      $UPTIME"
TEMPLATE_ASCII_MIDDLE
fi

# Add version checks if applicable
if [[ -n "$version_check" ]]; then
    cat >> "$TEMPLATES_DIR/$SERVICE.sh" << VERSION_SECTION
$version_check
VERSION_SECTION
else
    # Verwijder placeholder als er geen version check is
    sed -i '/VERSION_CHECK_PLACEHOLDER/d' "$TEMPLATES_DIR/$SERVICE.sh"
fi

# Add version display
cat >> "$TEMPLATES_DIR/$SERVICE.sh" << 'VERSION_DISPLAY'
# Version info (if available)
if [[ -n "$PIHOLE_VERSION" ]]; then
    echo -e "  ${YELLOW}ðŸ›¡ï¸  Pi-hole:${NC}     $PIHOLE_VERSION"
fi
if [[ -n "$DOCKER_VERSION" ]]; then
    echo -e "  ${YELLOW}ðŸ‹ Docker:${NC}      $DOCKER_VERSION"
fi
if [[ -n "$HASS_VERSION" ]]; then
    echo -e "  ${YELLOW}ðŸ  Home Assistant:${NC} $HASS_VERSION"
fi
VERSION_DISPLAY

# Vervang description en service name placeholders (escape special characters for sed)
description_escaped=$(echo "$description" | sed 's/[\/&]/\\&/g')
service_name_escaped=$(echo "$service_name" | sed 's/[\/&]/\\&/g')
sed -i "s/DESCRIPTION_PLACEHOLDER/$description_escaped/g" "$TEMPLATES_DIR/$SERVICE.sh"
sed -i "s/SERVICE_NAME_PLACEHOLDER/$service_name_escaped/g" "$TEMPLATES_DIR/$SERVICE.sh"

# Add Web UI if needed
if [[ -n "$webui_port" ]]; then
    # Check of het een URL of poort is
    if [[ "$webui_port" =~ ^https?:// ]]; then
        web_url="$webui_port"
    else
        # Gebruik hostname met domein suffix
        hostname_var="\$(hostname -s)"
        
        # Determine protocol (Proxmox and PBS use HTTPS)
        if [[ "$SERVICE" =~ ^(proxmox|pbs) ]]; then
            protocol="https"
        else
            protocol="http"
        fi
        
        web_url="${protocol}://${hostname_var}${DOMAIN_SUFFIX}:${webui_port}"
    fi
    
    cat >> "$TEMPLATES_DIR/$SERVICE.sh" << WEBUI_SECTION
echo -e "  \${YELLOW}ðŸ”— Web UI:\${NC}      \${CYAN}$web_url\${NC}"
WEBUI_SECTION
fi

# Sluit af met HLT end marker
cat >> "$TEMPLATES_DIR/$SERVICE.sh" << 'TEMPLATE_END'
echo ""
echo -e "${CYAN}==========================================${NC}"
echo ""
# === HLT-MOTD-END ===
TEMPLATE_END

chmod +x "$TEMPLATES_DIR/$SERVICE.sh"

echo ""
echo -e "${GREEN}âœ“ Template successfully created!${RESET}"
echo -e "  Location: ${CYAN}$TEMPLATES_DIR/$SERVICE.sh${RESET}"
echo ""

# Ask if deploy immediately (default = y)
read -p "$(echo -e "${YELLOW}Deploy now? (Y/n/q=cancel):${RESET} ")" deploy_now
if [[ "$deploy_now" == "q" || "$deploy_now" == "Q" ]]; then
    echo -e "${YELLOW}Skipped deployment${RESET}"
    exit 0
fi
deploy_now=${deploy_now:-y}

if [[ "$deploy_now" == "y" ]] || [[ "$deploy_now" == "Y" ]]; then
    echo ""
    if command -v deploy-motd &> /dev/null; then
        deploy-motd "$SERVICE"
    else
        echo -e "${RED}âœ— deploy-motd command not found${RESET}"
        echo -e "  Run manually: ${GREEN}deploy-motd $SERVICE${RESET}"
    fi
else
    echo ""
    echo -e "${YELLOW}Next step:${RESET}"
    echo -e "  ${GREEN}deploy-motd $SERVICE${RESET}"
    echo ""
fi
