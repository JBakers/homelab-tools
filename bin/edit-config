#!/bin/bash
set -euo pipefail

# Edit homelab tools configuration
# Author: J.Bakers
# Version: 3.5.0-dev.10

# Kleuren
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

CONFIG_FILE="/opt/homelab-tools/config.sh"

echo -e "${BOLD}${CYAN}╔══════════════════════════════════════════════════════════╗"
echo -e "║         ⚙️  Homelab Configuration                        ║"
echo -e "╚══════════════════════════════════════════════════════════╝${RESET}"
echo ""

# Load current config
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
else
    echo -e "${YELLOW}⚠${RESET} No configuration found, using defaults"
    DOMAIN_SUFFIX=".home"
    IP_METHOD="hostname"
fi

# Ask for new values (compact format)
echo -e "${BOLD}Huidige instellingen:${RESET}"
echo -e "  Domain: ${CYAN}${DOMAIN_SUFFIX:-<none>}${RESET}  |  IP methode: ${CYAN}${IP_METHOD}${RESET}"
echo ""

read -p "Domain suffix [${DOMAIN_SUFFIX}]: " new_domain
new_domain=${new_domain:-$DOMAIN_SUFFIX}

# Validate domain starts with dot if not empty
if [[ -n "$new_domain" ]] && [[ ! "$new_domain" =~ ^\. ]]; then
    echo -e "${RED}✗ Domain moet starten met '.' (bijv. .home) of leeg zijn${RESET}"
    exit 1
fi

read -p "IP methode (hostname/ip) [${IP_METHOD}]: " new_ip_method
new_ip_method=${new_ip_method:-$IP_METHOD}

# Validate IP method
if [[ "$new_ip_method" != "hostname" ]] && [[ "$new_ip_method" != "ip" ]]; then
    echo -e "${RED}✗ Error: IP method must be 'hostname' or 'ip'${RESET}"
    exit 1
fi

# Save configuration via temp file
TEMP_CONFIG=$(mktemp)
cat > "$TEMP_CONFIG" << EOF
# Homelab Tools Configuration
# Author: J.Bakers
# Version: 3.5.0-dev.10

# Domain suffix voor je homelab
# Wordt gebruikt voor Web UI URLs
DOMAIN_SUFFIX="$new_domain"

# IP detectie methode
# Opties: "hostname" of "ip"
IP_METHOD="$new_ip_method"
EOF

# Move temp file to final location with sudo
if sudo mv "$TEMP_CONFIG" "$CONFIG_FILE" && sudo chmod 644 "$CONFIG_FILE"; then
    echo ""
    echo -e "${GREEN}✓${RESET} Configuration saved!"
else
    echo ""
    echo -e "${RED}✗${RESET} Kon configuratie niet opslaan"
    rm -f "$TEMP_CONFIG"
    exit 1
fi
echo ""
echo -e "${BOLD}New settings:${RESET}"
echo -e "  Domain suffix: ${CYAN}$new_domain${RESET}"
echo -e "  IP method:     ${CYAN}$new_ip_method${RESET}"
echo ""
echo -e "${YELLOW}Note:${RESET} Regenerate MOTDs to apply new domain suffix:"
echo -e "  ${GREEN}generate-motd <service>${RESET}"
echo ""
