#!/bin/bash
set -euo pipefail

# Bulk generate MOTD templates for all hosts
# Author: J.Bakers
# Version: See VERSION file

# Load shared menu helper library
# Resolve symlinks to find the actual installation directory
# shellcheck source=../lib/menu-helpers.sh
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
source "$LIB_DIR/menu-helpers.sh"
source "$LIB_DIR/constants.sh"
source "$LIB_DIR/colors.sh"

# Read choice with q to cancel - returns to menu
# Usage: read_choice "prompt" variable default [valid_pattern]
# Returns 1 if cancelled (q pressed), 0 otherwise
read_choice() {
    local prompt="$1"
    local var_name="$2"
    local default="${3:-}"
    local input
    
    read -r -p "$(echo -e "${CYAN}${prompt}${RESET} ${YELLOW}(q=cancel)${RESET}: ")" input
    
    if [[ "$input" == "q" || "$input" == "Q" ]]; then
        return 1
    fi
    
    # Use default if empty
    if [[ -z "$input" && -n "$default" ]]; then
        input="$default"
    fi
    
    # Use printf -v for safe variable assignment (prevents eval injection)
    printf -v "$var_name" '%s' "$input"
    return 0
}

SSH_CONFIG="$HOME/.ssh/config"
TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"

show_help() {
    echo -e "${BOLD}${CYAN}bulk-generate-motd - Generate MOTDs for all hosts${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  bulk-generate-motd          # Interactive mode"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Generates MOTD templates for all hosts in SSH config."
    echo "  Choose between Default clean or ASCII art styles."
    echo "  Use Interactive mode to customize each host individually,"
    echo "  or Smart-detect mode for automatic generation."
    echo ""
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

# Main loop for returning to menu
while true; do
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ“ Bulk MOTD Generator                           â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Check SSH config
    if [[ ! -f "$SSH_CONFIG" ]]; then
        echo -e "${RED}âœ— SSH config not found: $SSH_CONFIG${RESET}"
        echo ""
        echo -e "  Create it first with:"
        echo -e "  ${GREEN}edit-ssh${RESET}"
        exit 1
    fi

    # Create templates directory
    mkdir -p "$TEMPLATES_DIR"

    # Read all hosts from SSH config
    hosts=$(grep "^Host " "$SSH_CONFIG" | awk '{print $2}' | grep -v '\*' | sort -u)
    host_count=$(echo "$hosts" | wc -l)

    if [[ $host_count -eq 0 ]]; then
        echo -e "${YELLOW}âš  No hosts found in SSH config${RESET}"
        echo ""
        echo -e "  Add hosts with:"
        echo -e "  ${GREEN}edit-ssh${RESET}"
        exit 0
    fi

    echo -e "${BOLD}Found ${GREEN}$host_count${RESET} ${BOLD}hosts in SSH config${RESET}"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Step 1: Choose style type
    echo -e "${BOLD}${CYAN}Step 1: Choose MOTD Style${RESET}"
    echo ""
    
    choose_menu "Choose MOTD Style" \
        "Default Clean MOTD|Functional & informative, no ASCII art" \
        "ASCII Art MOTD|Choose from 6 artistic styles"
    
    style_type=$((HLT_MENU_RESULT + 1))  # Convert 0-based to 1-based
    
    # Check if cancelled
    if [[ $HLT_MENU_RESULT -eq -1 ]]; then
        break  # Return to homelab menu
    fi

    # ASCII style selection with preview
    ascii_style=""
    # shellcheck disable=SC2154
    if [[ "$style_type" == "2" ]]; then
        echo ""
        
        if command -v toilet &> /dev/null; then
            while true; do
                choose_menu "Choose ASCII Art Style" \
                    "Clean & Functional|No ASCII - Default" \
                    "Rainbow Future|Colorful, modern" \
                    "Rainbow Standard|Colorful, classic" \
                    "Mono Future|Black & white, modern" \
                    "Big Mono|Large, bold" \
                    "Small/Smblock|Compact" \
                    "PREVIEW|Show all styles"
                
                choice_idx=$HLT_MENU_RESULT
                
                # Check if cancelled
                if [[ $choice_idx -eq -1 ]]; then
                    ascii_style=""
                    break 2  # Break out of both loops
                fi
                
                # Handle preview (last option)
                if [[ $choice_idx -eq 6 ]]; then
                    clear
                    echo -e "${BOLD}${CYAN}ASCII Art Preview${RESET}"
                    echo ""
                    toilet -f future --gay "TEST" 2>/dev/null || echo "Style 2: Rainbow Future"
                    echo ""
                    toilet -f standard --gay "TEST" 2>/dev/null || echo "Style 3: Rainbow Standard"
                    echo ""
                    toilet -f future "TEST" 2>/dev/null || echo "Style 4: Mono Future"
                    echo ""
                    toilet -f bigmono9 "TEST" 2>/dev/null || echo "Style 5: Big Mono"
                    echo ""
                    toilet -f smblock "TEST" 2>/dev/null || echo "Style 6: Small/Smblock"
                    echo ""
                    echo -e "${YELLOW}Press Enter to continue (q=cancel)...${RESET}"
                    read -rsn1 preview_key < /dev/tty 2>/dev/null || true
                    if [[ "$preview_key" == "q" || "$preview_key" == "Q" ]]; then
                        break 2  # Return to main menu
                    fi
                    clear
                    continue
                fi
                
                # Valid style selected (convert 0-based to 1-based for ASCII mapping)
                ascii_style=$((choice_idx + 1))
                break
            done
        else
            echo -e "${YELLOW}âš  Toilet not installed - ASCII art not available${RESET}"
            echo -e "  For ASCII art: ${GREEN}sudo apt install toilet toilet-fonts${RESET}"
            echo -e "  Falling back to Clean & Functional style"
            echo ""
            ascii_style="1"
        fi
    else
        # Default style = style 1 (clean)
        ascii_style="1"
    fi

    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Step 2: Choose generation mode
    echo -e "${BOLD}${CYAN}Step 2: Choose Generation Mode${RESET}"
    echo ""
    
    choose_menu "Choose Generation Mode" \
        "Interactive Mode|Customize each host individually" \
        "Smart-Detect Mode|Automatic generation for all hosts"
    
    gen_mode=$((HLT_MENU_RESULT + 1))  # Convert 0-based to 1-based
    
    # Check if cancelled
    if [[ $HLT_MENU_RESULT -eq -1 ]]; then
        break  # Return to homelab menu
    fi

    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Show what will happen
    # shellcheck disable=SC2154
    if [[ "$gen_mode" == "1" ]]; then
        echo -e "${YELLOW}â†’${RESET} ${BOLD}Starting Interactive Mode...${RESET}"
        echo -e "  You will be prompted to customize each host individually"
    else
        echo -e "${GREEN}âœ“${RESET} ${BOLD}Starting Smart-Detect Mode...${RESET}"
        if [[ "$ascii_style" == "1" ]]; then
            echo -e "  Generating all hosts with ${CYAN}Clean & Functional${RESET} style"
        else
            echo -e "  Generating all hosts with ${CYAN}ASCII style $ascii_style${RESET}"
        fi
        echo -e "  Auto-detecting settings for each host"
    fi
    echo ""

    # Counters and tracking
    generated=0
    skipped=0
    failed=0
    declare -a skipped_hosts=()
    declare -a skipped_reasons=()

    # Initialize progress display for Smart-detect mode
    current=0
    
    # Disable -e during bulk generation to tolerate non-critical failures
    set +e
    if [[ "$gen_mode" == "2" ]]; then
        # Smart-detect mode will show progress bar
        :
    fi

    # Loop through hosts
    for hostname in $hosts; do
        template_file="$TEMPLATES_DIR/${hostname}.sh"
        ((current++))

        # Update progress bar for Smart-detect mode
        if [[ "$gen_mode" == "2" ]]; then
            show_progress "$current" "$host_count" "$hostname" "${YELLOW}Processing...${RESET}"
        else
            # Interactive mode: show traditional output
            echo -e "${BOLD}${CYAN}Host: ${hostname}${RESET}"
        fi

        # Check if system is unsupported
        hostname_lower="${hostname,,}"  # Bash 4+ lowercase expansion
        is_unsupported=false
        for unsupported in "${UNSUPPORTED_SYSTEMS[@]}"; do
            if [[ "$hostname_lower" == "$unsupported" ]]; then
                if [[ "$gen_mode" == "2" ]]; then
                    show_progress "$current" "$host_count" "$hostname" "${YELLOW}âš  System doesn't support MOTD - Skipped${RESET}"
                    sleep 0.5
                else
                    echo -e "  ${YELLOW}âš ${RESET} System doesn't support MOTD"
                    echo -e "  ${YELLOW}â†’${RESET} Skipped"
                    echo ""
                fi
                skipped=$((skipped + 1))
                skipped_hosts+=("$hostname")
                skipped_reasons+=("System doesn't support MOTD")
                is_unsupported=true
                break
            fi
        done

        # Skip to next host if unsupported
        if [[ "$is_unsupported" == "true" ]]; then
            continue
        fi

        # Check if template exists
        if [[ -f "$template_file" ]]; then
            if [[ "$gen_mode" == "2" ]]; then
                # Smart mode: always overwrite
                show_progress "$current" "$host_count" "$hostname" "${YELLOW}Template exists - Overwriting${RESET}"
            else
                # Interactive mode: ask
                echo -e "  ${YELLOW}âš ${RESET} Template already exists"
                read -r -p "  Overwrite? (1=Yes, 2=No, q=cancel): " overwrite
                if [[ "$overwrite" == "q" || "$overwrite" == "Q" ]]; then
                    echo -e "\n${YELLOW}â†’${RESET} Cancelled by user"
                    break 2  # Return to main menu
                fi
                overwrite=${overwrite:-1}
                if [[ "$overwrite" != "1" ]]; then
                    echo -e "  ${YELLOW}â†’${RESET} Skipped"
                    skipped=$((skipped + 1))
                    skipped_hosts+=("$hostname")
                    skipped_reasons+=("Template exists - user declined overwrite")
                    echo ""
                    continue
                fi
            fi
        fi

        # Generate based on mode
        if [[ "$gen_mode" == "2" ]]; then
            # Smart-detect mode: auto-generate with chosen style
            show_progress "$current" "$host_count" "$hostname" "${CYAN}Generating MOTD...${RESET}"

            # Smart-detect: auto-generate with chosen style
            # Use proper error handling instead of set +e toggles
            echo -e "n\n${ascii_style}\nn\n" | generate-motd "$hostname" &>/dev/null
            gen_status=$?

            if [[ $gen_status -eq 0 && -f "$template_file" ]]; then
                show_progress "$current" "$host_count" "$hostname" "${GREEN}âœ“ Generated successfully${RESET}"
                generated=$((generated + 1))
                sleep 0.3
            else
                show_progress "$current" "$host_count" "$hostname" "${RED}âœ— Generation failed${RESET}"
                failed=$((failed + 1))
                sleep 0.5
            fi
        else
            # Interactive mode: call generate-motd interactively
            echo -e "  ${YELLOW}â†’${RESET} Interactive customization..."
            echo ""

            # Pre-fill with chosen ASCII style
            echo -e "y\n${ascii_style}\nn\n" | generate-motd "$hostname"
            gen_status=$?

            if [[ $gen_status -eq 0 && -f "$template_file" ]]; then
                echo -e "  ${GREEN}âœ“${RESET} Generated"
                generated=$((generated + 1))
            else
                echo -e "  ${YELLOW}â†’${RESET} Skipped or failed"
                skipped=$((skipped + 1))
                skipped_hosts+=("$hostname")
                skipped_reasons+=("Generation skipped or failed")
            fi
            echo ""
        fi
    done

    # Restore -e after generation loop
    set -e

    # Finish progress display for Smart-detect mode
    if [[ "$gen_mode" == "2" ]]; then
        finish_progress
        sleep 0.3  # Brief pause before clearing
        clear
        echo ""  # Spacing after clear
        echo ""  # Extra spacing for readability
    fi

    # Summary
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${BOLD}${CYAN}                 Generation Summary                        ${RESET}"
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${GREEN}âœ“ Generated:${RESET} $generated"
    echo -e "${YELLOW}â†’ Skipped:${RESET}   $skipped"
    if [[ $failed -gt 0 ]]; then
        echo -e "${RED}âœ— Failed:${RESET}    $failed"
    fi
    
    # Show skipped hosts with reasons
    if [[ $skipped -gt 0 ]]; then
        echo ""
        echo -e "${BOLD}${YELLOW}Skipped Hosts:${RESET}"
        for ((i=0; i<${#skipped_hosts[@]}; i++)); do
            echo -e "  ${YELLOW}â†’${RESET} ${skipped_hosts[$i]}: ${skipped_reasons[$i]}"
        done
    fi
    
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # If running non-interactively (piped input), stop here with success
    if [[ ! -t 0 ]]; then
        exit 0
    fi

    # Initialize failed_hosts array (used by retry option)
    failed_hosts=()

    # Bulk deploy option
    if [[ $generated -gt 0 ]]; then
        echo -e "${BOLD}${CYAN}Step 3: Deployment${RESET}"
        echo ""
        echo -e "  ${GREEN}âœ“${RESET} Templates generated successfully!"
        echo ""
        echo -e "${BOLD}Deploy all generated MOTDs to hosts now?${RESET}"
        echo ""
        
        choose_menu "Deployment Choice" \
            "Yes, deploy now via SSH|Start deployment immediately" \
            "No, deploy manually later|Save templates, deploy later"
        
        deploy_all=$((HLT_MENU_RESULT + 1))  # Convert 0-based to 1-based
        
        # Check if cancelled
        if [[ $HLT_MENU_RESULT -eq -1 ]]; then
            break  # Return to main menu
        fi

        if [[ "$deploy_all" == "1" ]]; then
            echo ""
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo -e "${BOLD}${CYAN}                   ğŸš€ Deploying MOTDs                       ${RESET}"
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""

            deployed=0
            deploy_failed=0
            failed_hosts=()

            for hostname in $hosts; do
                template_file="$TEMPLATES_DIR/${hostname}.sh"

                # Only deploy if template exists
                if [[ -f "$template_file" ]]; then
                    echo -e "${BOLD}${CYAN}Deploying to: ${hostname}${RESET}"

                    # Run deploy-motd with visible output (may need user input for non-HLT MOTDs)
                    if deploy-motd "$hostname"; then
                        echo -e "  ${GREEN}âœ“${RESET} Deployed successfully"
                        deployed=$((deployed + 1))
                    else
                        echo -e "  ${RED}âœ—${RESET} Deployment failed"
                        deploy_failed=$((deploy_failed + 1))
                        failed_hosts+=("$hostname")
                    fi
                    echo ""
                fi
            done

            echo ""
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo -e "${BOLD}${CYAN}                Deployment Summary                         ${RESET}"
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""
            echo -e "${GREEN}âœ“ Deployed:${RESET} $deployed"
            if [[ $deploy_failed -gt 0 ]]; then
                echo -e "${RED}âœ— Failed:${RESET}   $deploy_failed"
                echo ""
                echo -e "${YELLOW}Failed hosts:${RESET}"
                for failed_host in "${failed_hosts[@]}"; do
                    echo -e "  ${RED}â†’${RESET} $failed_host"
                done
            fi
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""
            
            # Store failed hosts for retry option
            export BULK_FAILED_HOSTS="${failed_hosts[*]}"
        else
            echo ""
            echo -e "${BOLD}${YELLOW}Manual Deployment Instructions:${RESET}"
            echo ""
            echo -e "  Templates have been generated but not deployed."
            echo -e "  To deploy them manually, use one of these methods:"
            echo ""
            echo -e "  ${BOLD}1. Deploy individual hosts:${RESET}"
            echo -e "     ${GREEN}deploy-motd <hostname>${RESET}"
            echo -e "     Example: ${GREEN}deploy-motd pihole${RESET}"
            echo ""
            echo -e "  ${BOLD}2. View all templates:${RESET}"
            echo -e "     ${GREEN}list-templates${RESET}"
            echo ""
            echo -e "  ${BOLD}3. Run this tool again:${RESET}"
            echo -e "     ${GREEN}bulk-generate-motd${RESET}"
            echo -e "     (Will skip existing templates)"
            echo ""
        fi
    fi

    # Return to menu or exit
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}What would you like to do next?${RESET}"
    echo ""
    
    if [[ ${#failed_hosts[@]} -gt 0 ]]; then
        choose_menu "Next Action" \
            "Back to Homelab menu|Return to main menu" \
            "Generate more|Restart bulk-generate" \
            "Retry failed deployments|Retry ${#failed_hosts[@]} hosts" \
            "Quit|Exit program"
    else
        choose_menu "Next Action" \
            "Back to Homelab menu|Return to main menu" \
            "Generate more|Restart bulk-generate" \
            "Quit|Exit program"
    fi
    
    next_action=$((HLT_MENU_RESULT + 1))  # Convert 0-based to 1-based
    
    # Check if cancelled
    if [[ $HLT_MENU_RESULT -eq -1 ]]; then
        break  # Return to homelab menu
    fi

    case "$next_action" in
        1)
            # Back to homelab main menu
            break
            ;;
        2)
            # Restart bulk-generate loop - clear screen first
            clear
            continue
            ;;
        3)
            if [[ ${#failed_hosts[@]} -gt 0 ]]; then
                # Retry failed deployments
                clear
                echo ""
                echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo -e "${BOLD}${CYAN}           ğŸ”„ Retry Failed Deployments                      ${RESET}"
                echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                
                retry_deployed=0
                retry_failed=0
                
                for hostname in "${failed_hosts[@]}"; do
                    echo -e "${BOLD}${CYAN}Deploying to: ${hostname}${RESET}"
                    if deploy-motd "$hostname"; then
                        echo -e "  ${GREEN}âœ“${RESET} Deployed successfully"
                        retry_deployed=$((retry_deployed + 1))
                    else
                        echo -e "  ${RED}âœ—${RESET} Deployment failed again"
                        retry_failed=$((retry_failed + 1))
                    fi
                    echo ""
                done
                
                echo ""
                echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo -e "${BOLD}${CYAN}                Retry Summary                              ${RESET}"
                echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                echo -e "${GREEN}âœ“ Deployed:${RESET} $retry_deployed"
                if [[ $retry_failed -gt 0 ]]; then
                    echo -e "${RED}âœ— Still failed:${RESET} $retry_failed"
                fi
                echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                
                # Clear failed hosts after retry
                failed_hosts=()
                continue
            else
                # Quit
                echo ""
                echo -e "${GREEN}âœ“${RESET} Done! Have a great day!"
                echo ""
                exit 0
            fi
            ;;
        4)
            # Quit (only available when there are failed hosts)
            echo ""
            echo -e "${GREEN}âœ“${RESET} Done! Have a great day!"
            echo ""
            exit 0
            ;;
        *)
            # Quit
            echo ""
            echo -e "${GREEN}âœ“${RESET} Done! Have a great day!"
            echo ""
            exit 0
            ;;
    esac
done
