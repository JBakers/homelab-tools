#!/bin/bash
set -euo pipefail

# Deploy MOTD to remote host
# Author: J.Bakers
# Version: 3.5.0-dev.31

# Kleuren
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"

show_help() {
    echo -e "${BOLD}${CYAN}deploy-motd - Deploy MOTD to container${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  deploy-motd <service-name>"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Deploys an MOTD template to the corresponding container."
    echo "  The script:"
    echo "  1. Checks if the template exists"
    echo "  2. Copies the template to /etc/profile.d/ on the container"
    echo "  3. Tests the connection"
    echo "  4. Makes the template executable"
    echo ""
    echo -e "${BOLD}REQUIREMENTS:${RESET}"
    echo "  - SSH access to the container"
    echo "  - Same hostname as service name OR"
    echo "  - SSH config entry for the service name"
    echo ""
    echo -e "${BOLD}EXAMPLE:${RESET}"
    echo -e "  ${GREEN}deploy-motd pihole${RESET}"
    echo ""
    echo "  This deploys to:"
    echo "    ssh pihole"
    echo ""
    echo -e "${BOLD}SSH CONFIG:${RESET}"
    echo "  Make sure you have an entry in ~/.ssh/config:"
    echo ""
    echo "  Host pihole"
    echo "    HostName 192.168.1.25"
    echo "    User root"
    echo ""
    echo -e "${BOLD}NOTE:${RESET}"
    echo "  After deployment, the MOTD is automatically shown on"
    echo "  every new SSH session with current information."
    echo ""
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

SERVICE=${1:-}

if [[ -z "$SERVICE" ]]; then
    echo -e "${RED}âœ— Error: No service name provided${RESET}"
    echo -e "  Gebruik: ${GREEN}deploy-motd <service-naam>${RESET}"
    echo -e "  Voorbeeld: ${GREEN}deploy-motd pihole${RESET}"
    echo -e "  Of: ${CYAN}deploy-motd --help${RESET} voor meer informatie"
    exit 1
fi

# Validate service name to prevent command injection
if [[ ! "$SERVICE" =~ ^[a-zA-Z0-9._-]+$ ]]; then
    echo -e "${RED}âœ— Error: Invalid service name${RESET}"
    echo -e "  Alleen letters, cijfers, punten, underscores en streepjes zijn toegestaan"
    echo -e "  Voorbeeld: ${GREEN}deploy-motd pihole${RESET}"
    exit 1
fi

TEMPLATE_FILE="$TEMPLATES_DIR/$SERVICE.sh"

if [[ ! -f "$TEMPLATE_FILE" ]]; then
    echo -e "${RED}âœ— Error: Template not found${RESET}"
    echo -e "  Verwacht: ${CYAN}$TEMPLATE_FILE${RESET}"
    echo -e ""
    echo -e "  Genereer eerst een template:"
    echo -e "  ${GREEN}generate-motd $SERVICE${RESET}"
    exit 1
fi

echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘         ðŸš€ MOTD Deploy                                    â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""
echo -e "${BOLD}Service: ${GREEN}$SERVICE${RESET}"
echo -e "Template: ${CYAN}$TEMPLATE_FILE${RESET}"
echo ""

# Test SSH connectie
echo -e "${YELLOW}â†’${RESET} Test SSH connectie..."
if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "$SERVICE" "echo 2>&1" &>/dev/null; then
    echo -e "${RED}âœ— Kan niet verbinden met $SERVICE${RESET}"
    echo -e ""
    echo -e "  Controleer:"
    echo -e "  1. SSH config: ${CYAN}~/.ssh/config${RESET}"
    echo -e "  2. SSH keys zijn geconfigureerd"
    echo -e "  3. Container is online"
    echo -e ""
    echo -e "  Voorbeeld SSH config entry:"
    echo -e "  ${CYAN}Host $SERVICE${RESET}"
    echo -e "  ${CYAN}  HostName 192.168.1.xx${RESET}"
    echo -e "  ${CYAN}  User root${RESET}"
    exit 1
fi
echo -e "${GREEN}âœ“${RESET} SSH connectie OK"

# Cleanup old MOTD files
echo -e "${YELLOW}â†’${RESET} Cleaning up old MOTD..."
ssh "$SERVICE" "rm -f /etc/motd /etc/update-motd.d/* 2>/dev/null || sudo rm -f /etc/motd /etc/update-motd.d/* 2>/dev/null"
echo -e "${GREEN}âœ“${RESET} Old MOTD removed"

# Create profile.d directory if it doesn't exist
echo -e "${YELLOW}â†’${RESET} Checking /etc/profile.d/..."
ssh "$SERVICE" "mkdir -p /etc/profile.d 2>/dev/null || sudo mkdir -p /etc/profile.d 2>/dev/null"

# Deploy new MOTD
echo -e "${YELLOW}â†’${RESET} Deploy nieuwe MOTD..."

# Probeer eerst zonder sudo
if scp "$TEMPLATE_FILE" "$SERVICE:/etc/profile.d/00-motd.sh" 2>/dev/null; then
    echo -e "${GREEN}âœ“${RESET} Template gekopieerd"
    use_sudo=""
else
    # Als dat faalt, kopieer naar /tmp en verplaats met sudo
    echo -e "${YELLOW}  â†’${RESET} No direct access, using sudo..."
    if scp "$TEMPLATE_FILE" "$SERVICE:/tmp/00-motd.sh" 2>/dev/null; then
        ssh "$SERVICE" "sudo mv /tmp/00-motd.sh /etc/profile.d/00-motd.sh" 2>/dev/null
        if [[ $? -eq 0 ]]; then
            echo -e "${GREEN}âœ“${RESET} Template gekopieerd (via sudo)"
            use_sudo="sudo"
        else
            echo -e "${RED}âœ— Error copying template${RESET}"
            echo -e ""
            echo -e "  ${YELLOW}Mogelijke oorzaken:${RESET}"
            echo -e "  - User heeft geen sudo rechten"
            echo -e "  - /etc/profile.d/ bestaat niet en kan niet aangemaakt worden"
            echo -e ""
            echo -e "  ${YELLOW}Handmatige fix:${RESET}"
            echo -e "  ${CYAN}ssh $SERVICE${RESET}"
            echo -e "  ${CYAN}sudo mkdir -p /etc/profile.d${RESET}"
            exit 1
        fi
    else
        echo -e "${RED}âœ— Cannot copy to remote host${RESET}"
        echo ""
        read -p "$(echo -e ${YELLOW}Debug connection? \(y/N\):${RESET} )" debug
        if [[ "$debug" =~ ^[Yy]$ ]]; then
            echo ""
            echo -e "${CYAN}=== SSH Connection Debug ===${RESET}"
            echo -e "${YELLOW}Testing connection...${RESET}"
            ssh -v "$SERVICE" "echo 2>&1" 2>&1 | tail -20
        fi
        exit 1
    fi
fi

# Maak executable
echo -e "${YELLOW}â†’${RESET} Configureer permissions..."
if [[ -n "$use_sudo" ]]; then
    if ! ssh "$SERVICE" "sudo chmod +x /etc/profile.d/00-motd.sh" 2>/dev/null; then
        echo -e "${RED}âœ— Kan permissions niet instellen${RESET}"
        echo ""
        read -p "$(echo -e ${YELLOW}Debug? \(y/N\):${RESET} )" debug
        if [[ "$debug" =~ ^[Yy]$ ]]; then
            echo ""
            echo -e "${CYAN}=== Permission Debug ===${RESET}"
            ssh "$SERVICE" "ls -la /etc/profile.d/00-motd.sh 2>&1"
            echo ""
            echo -e "${YELLOW}Try manual fix:${RESET}"
            echo -e "  ${CYAN}ssh $SERVICE${RESET}"
            echo -e "  ${CYAN}sudo chmod +x /etc/profile.d/00-motd.sh${RESET}"
        fi
        exit 1
    fi
else
    if ! ssh "$SERVICE" "chmod +x /etc/profile.d/00-motd.sh" 2>/dev/null; then
        echo -e "${RED}âœ— Kan permissions niet instellen${RESET}"
        echo ""
        read -p "$(echo -e ${YELLOW}Debug? \(y/N\):${RESET} )" debug
        if [[ "$debug" =~ ^[Yy]$ ]]; then
            echo ""
            echo -e "${CYAN}=== Permission Debug ===${RESET}"
            ssh "$SERVICE" "ls -la /etc/profile.d/00-motd.sh 2>&1"
            echo ""
            echo -e "${YELLOW}Try manual fix:${RESET}"
            echo -e "  ${CYAN}ssh $SERVICE${RESET}"
            echo -e "  ${CYAN}chmod +x /etc/profile.d/00-motd.sh${RESET}"
        fi
        exit 1
    fi
fi
echo -e "${GREEN}âœ“${RESET} Permissions ingesteld"

# Log the deployment
DEPLOY_LOG="$HOME/.local/share/homelab-tools/deploy-log"
mkdir -p "$(dirname "$DEPLOY_LOG")"
echo "$(date +%s)|$SERVICE|$SERVICE|deployed" >> "$DEPLOY_LOG"

echo ""
echo -e "${GREEN}âœ“ Deployment succesvol!${RESET}"
echo ""
echo -e "${YELLOW}Test de MOTD:${RESET}"
echo -e "  ${GREEN}ssh $SERVICE${RESET}"
echo ""
