#!/bin/bash
set -euo pipefail

# Bulk generate MOTD templates for all hosts
# Author: J.Bakers
# Version: 3.4.0

# Kleuren
CYAN='\033[0;36m'
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

SSH_CONFIG="$HOME/.ssh/config"
TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"

show_help() {
    echo -e "${BOLD}${CYAN}bulk-generate-motd - Generate MOTDs for all hosts${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  bulk-generate-motd          # Interactive mode"
    echo "  bulk-generate-motd --yes    # Auto-confirm overwrites"
    echo "  bulk-generate-motd --all    # Fully automatic"
    echo ""
    echo -e "${BOLD}OPTIONS:${RESET}"
    echo "  --yes, -y    Auto-confirm overwrite prompts"
    echo "  --all, -a    Generate all hosts automatically"
    echo ""
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

# Check for --all flag
AUTO_ALL=false
AUTO_YES=false
if [[ "${1:-}" == "--all" ]] || [[ "${1:-}" == "-a" ]]; then
    AUTO_ALL=true
elif [[ "${1:-}" == "--yes" ]] || [[ "${1:-}" == "-y" ]]; then
    AUTO_YES=true
fi

echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘       ğŸ“ Bulk MOTD Generator                          â•‘"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

if [[ "$AUTO_ALL" == true ]]; then
    echo -e "${GREEN}ğŸš€ AUTO MODE:${RESET} Generating all hosts with auto-detection"
    echo ""
elif [[ "$AUTO_YES" == true ]]; then
    echo -e "${GREEN}âœ“ YES MODE:${RESET} Auto-confirming overwrites"
    echo ""
fi

# Check SSH config
if [[ ! -f "$SSH_CONFIG" ]]; then
    echo -e "${RED}âœ— SSH config not found: $SSH_CONFIG${RESET}"
    echo ""
    echo -e "  Create it first with:"
    echo -e "  ${GREEN}edit-ssh${RESET}"
    exit 1
fi

# Maak templates directory
mkdir -p "$TEMPLATES_DIR"

# Lees alle hosts uit SSH config
hosts=$(grep "^Host " "$SSH_CONFIG" | awk '{print $2}' | grep -v '\*' | sort -u)
host_count=$(echo "$hosts" | wc -l)

if [[ $host_count -eq 0 ]]; then
    echo -e "${YELLOW}âš  No hosts found in SSH config${RESET}"
    echo ""
    echo -e "  Add hosts with:"
    echo -e "  ${GREEN}edit-ssh${RESET}"
    exit 0
fi

echo -e "${BOLD}Found ${GREEN}$host_count${RESET} ${BOLD}hosts in SSH config${RESET}"
echo ""

# Counters
generated=0
skipped=0
failed=0

# Loop door hosts
for hostname in $hosts; do
    template_file="$TEMPLATES_DIR/${hostname}.sh"
    
    echo -e "${BOLD}${BLUE}Host: ${CYAN}$hostname${RESET}"
    
    # In AUTO_ALL mode: skip prompts, just generate
    if [[ "$AUTO_ALL" == true ]]; then
        echo -e "  ${YELLOW}â†’${RESET} Auto-generating with detection..."
        
        # Skip if exists unless we're in overwrite-all mode
        if [[ -f "$template_file" ]]; then
            echo -e "  ${YELLOW}âš ${RESET} Template exists, overwriting..."
        fi
        
        # Generate with auto-detection (clean MOTD = style 1)
        # Answers: customize=n, style=1 (clean), deploy=n (bulk deploys later)
        echo -e "n\n1\nn\n" | generate-motd "$hostname" &>/dev/null
        
        if [[ -f "$template_file" ]]; then
            echo -e "  ${GREEN}âœ“${RESET} Generated successfully"
            ((generated++))
        else
            echo -e "  ${RED}âœ—${RESET} Generation failed"
            ((failed++))
        fi
        echo ""
        continue
    fi
    
    # Normal interactive mode
    # Check of template al bestaat
    if [[ -f "$template_file" ]]; then
        echo -e "  ${YELLOW}âš ${RESET} Template already exists"
        
        if [[ "$AUTO_YES" == true ]]; then
            echo -e "  ${GREEN}âœ“${RESET} Auto-confirming overwrite (--yes mode)"
        else
            read -p "  Overwrite? (Y/n): " overwrite
            overwrite=${overwrite:-y}
            if [[ ! "$overwrite" =~ ^[Yy]$ ]]; then
                echo -e "  ${YELLOW}â†’${RESET} Skipped"
                ((skipped++))
                echo ""
                continue
            fi
        fi
    fi
    
    # Vraag hoe te genereren
    echo -e "  Generate MOTD for ${CYAN}$hostname${RESET}?"
    echo -e "    ${GREEN}y${RESET}) Yes, use auto-detection (clean MOTD)"
    echo -e "    ${GREEN}i${RESET}) Interactive (choose style, details)"
    echo -e "    ${GREEN}a${RESET}) Yes to all remaining (clean MOTDs)"
    echo -e "    ${GREEN}n${RESET}) Skip"
    read -p "  Choice (Y/i/a/n): " choice
    choice=${choice:-y}

    # Handle "yes to all" - switch to AUTO_ALL mode
    if [[ "$choice" =~ ^[Aa]$ ]]; then
        AUTO_ALL=true
        echo -e "  ${GREEN}âœ“${RESET} Switching to auto-mode for remaining hosts"
        choice="y"
    fi
    
    case "$choice" in
        y|Y)
            # Gebruik auto-detection en defaults
            echo -e "  ${YELLOW}â†’${RESET} Generating with auto-detection (clean MOTD)..."

            # Call generate-motd met auto-detection
            # Answers: customize=n, style=1 (clean), deploy=n (bulk deploys later)
            echo -e "n\n1\nn\n" | generate-motd "$hostname" &>/dev/null
            
            if [[ -f "$template_file" ]]; then
                echo -e "  ${GREEN}âœ“${RESET} Generated successfully"
                ((generated++))
            else
                echo -e "  ${RED}âœ—${RESET} Generation failed"
                ((failed++))
            fi
            ;;
            
        i|I)
            # Interactive mode
            echo -e "  ${YELLOW}â†’${RESET} Interactive mode..."
            echo ""
            generate-motd "$hostname"
            
            if [[ -f "$template_file" ]]; then
                ((generated++))
            else
                ((failed++))
            fi
            ;;
            
        *)
            echo -e "  ${YELLOW}â†’${RESET} Skipped"
            ((skipped++))
            ;;
    esac
    
    echo ""
done

# Samenvatting
echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo -e "${GREEN}âœ“ Generated:${RESET} $generated"
echo -e "${YELLOW}â†’ Skipped:${RESET}   $skipped"
if [[ $failed -gt 0 ]]; then
    echo -e "${RED}âœ— Failed:${RESET}    $failed"
fi
echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

# Bulk deploy optie
if [[ $generated -gt 0 ]]; then
    echo -e "${BOLD}Deploy all generated MOTDs to hosts?${RESET}"
    read -p "Deploy now? (Y/n): " deploy_all
    deploy_all=${deploy_all:-y}
    
    if [[ "$deploy_all" =~ ^[Yy]$ ]]; then
        echo ""
        echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo -e "${BOLD}${CYAN}           ğŸš€ Deploying MOTDs...                         ${RESET}"
        echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        
        deployed=0
        deploy_failed=0
        
        for hostname in $hosts; do
            template_file="$TEMPLATES_DIR/${hostname}.sh"
            
            # Deploy alleen als template bestaat en nieuw gegenereerd is
            if [[ -f "$template_file" ]]; then
                echo -e "${BOLD}${BLUE}Deploying to: ${CYAN}$hostname${RESET}"
                
                if deploy-motd "$hostname" &>/dev/null; then
                    echo -e "  ${GREEN}âœ“${RESET} Deployed successfully"
                    ((deployed++))
                else
                    echo -e "  ${RED}âœ—${RESET} Deployment failed"
                    ((deploy_failed++))
                fi
            fi
        done
        
        echo ""
        echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo -e "${GREEN}âœ“ Deployed:${RESET} $deployed"
        if [[ $deploy_failed -gt 0 ]]; then
            echo -e "${RED}âœ— Failed:${RESET}   $deploy_failed"
        fi
        echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
    else
        echo -e "${YELLOW}Next steps:${RESET}"
        echo -e "  ${GREEN}list-templates${RESET}  - View all templates"
        echo -e "  ${GREEN}deploy-motd <host>${RESET} - Deploy to a specific host"
        echo ""
    fi
fi
