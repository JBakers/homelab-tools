name: Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  static-tests:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      
      - name: Syntax check all scripts
        run: |
          echo "Checking bash syntax..."
          for script in bin/*; do
            if [[ -f "$script" ]]; then
              bash -n "$script" || exit 1
              echo "✓ $script"
            fi
          done
          for lib in lib/*.sh; do
            bash -n "$lib" || exit 1
            echo "✓ $lib"
          done
          echo "✓ All scripts have valid syntax"
      
      - name: ShellCheck
        run: |
          echo "Running ShellCheck..."
          shellcheck --severity=error bin/* lib/*.sh install.sh uninstall.sh || exit 1
          echo "✓ ShellCheck passed"

  docker-tests:
    name: Docker Integration Tests
    runs-on: ubuntu-latest
    needs: static-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build test containers
        working-directory: .test-env
        run: |
          docker compose build --parallel
      
      - name: Start test environment
        working-directory: .test-env
        run: |
          docker compose up -d
          sleep 5  # Wait for containers to be ready
      
      - name: Run test suite
        working-directory: .test-env
        run: |
          docker compose exec -T testhost bash /workspace/.test-env/run-tests.sh
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: .test-env/results/
          retention-days: 7
      
      - name: Cleanup
        if: always()
        working-directory: .test-env
        run: |
          docker compose down -v --remove-orphans

  version-check:
    name: Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check VERSION file exists
        run: |
          if [[ ! -f VERSION ]]; then
            echo "ERROR: VERSION file not found"
            exit 1
          fi
          version=$(cat VERSION)
          echo "Version: $version"
          
          # Check version format
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-dev\.[0-9]+)?$ ]]; then
            echo "ERROR: Invalid version format: $version"
            echo "Expected: X.Y.Z or X.Y.Z-dev.NN"
            exit 1
          fi
          echo "✓ Version format OK"
