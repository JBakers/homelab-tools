#!/bin/bash
set -euo pipefail

# Enhanced SSH host configuration manager
# Author: J.Bakers
# Version: See VERSION file

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

SSH_CONFIG="$HOME/.ssh/config"
SSH_CONFIG_BACKUP="$HOME/.ssh/config.backup"

# Source menu helpers for arrow navigation (resolve symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# shellcheck source=../lib/menu-helpers.sh
source "${SCRIPT_DIR}/../lib/menu-helpers.sh"

show_help() {
    echo -e "${BOLD}${CYAN}edit-hosts - Enhanced host configuration manager${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  edit-hosts [options]"
    echo ""
    echo -e "${BOLD}OPTIONS:${RESET}"
    echo "  --help, -h        Show this help message"
    echo "  --edit            Open SSH config in editor (classic mode)"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Interactive SSH host configuration manager with:"
    echo "  â€¢ View and manage all configured hosts"
    echo "  â€¢ Add new hosts with guided wizard"
    echo "  â€¢ Edit, delete, or copy existing hosts"
    echo "  â€¢ Search and filter hosts"
    echo "  â€¢ Bulk operations (backup, export, batch delete)"
    echo ""
    echo -e "${BOLD}FILE LOCATION:${RESET}"
    echo "  ~/.ssh/config"
    echo ""
    echo -e "${BOLD}FEATURES:${RESET}"
    echo "  â€¢ Arrow key navigation in all menus"
    echo "  â€¢ Input validation for all fields"
    echo "  â€¢ Automatic backup before modifications"
    echo "  â€¢ Safe host copying with numeric suffixes"
    echo ""
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Function: confirm_action
# Description: Prompt user for yes/no confirmation
# Arguments:
#   $1 - Prompt message (default: "Are you sure?")
# Returns: 0 if confirmed (y/Y), 1 otherwise
# Globals: YELLOW, RESET
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
confirm_action() {
    local prompt="${1:-Are you sure?}"
    local response
    
    read -rp "$(echo -e "${YELLOW}${prompt} (y/N): ${RESET}")" response
    
    if [[ "$response" =~ ^[Yy]$ ]]; then
        return 0
    else
        return 1
    fi
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Function: init_ssh_config
# Description: Initialize SSH config directory and file structure
# Arguments: None
# Returns: 0 on success
# Globals: HOME, YELLOW, GREEN, RESET
# Notes: Creates ~/.ssh and ~/.ssh/config if they don't exist
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init_ssh_config() {
    if [[ ! -d "$HOME/.ssh" ]]; then
        echo -e "${YELLOW}â†’${RESET} Creating ~/.ssh directory..."
        mkdir -p "$HOME/.ssh"
        chmod 700 "$HOME/.ssh"
    fi

    if [[ ! -f "$SSH_CONFIG" ]]; then
        echo -e "${YELLOW}â†’${RESET} Creating new SSH config file..."
        cat > "$SSH_CONFIG" << 'EOF'
# SSH Configuration
# Managed by homelab-tools

# Example:
# Host pihole
#   HostName 192.168.1.100
#   User admin
#   Port 22
#   IdentityFile ~/.ssh/id_ed25519

EOF
        chmod 600 "$SSH_CONFIG"
    fi
}

# Parse SSH config and extract hosts
# Returns: Array of host names
get_all_hosts() {
    if [[ ! -f "$SSH_CONFIG" ]]; then
        return
    fi
    
    grep -E "^Host " "$SSH_CONFIG" 2>/dev/null | awk '{print $2}' | grep -v "\*" || true
}

# Get host details
# Args: $1 = hostname
get_host_details() {
    local hostname="$1"
    local in_host=0
    local details=""
    
    while IFS= read -r line; do
        if [[ "$line" =~ ^Host[[:space:]]+${hostname}$ ]]; then
            in_host=1
            details="Host: $hostname"$'\n'
            continue
        fi
        
        if [[ $in_host -eq 1 ]]; then
            if [[ "$line" =~ ^Host[[:space:]] ]]; then
                break
            fi
            
            if [[ "$line" =~ ^[[:space:]]*(HostName|User|Port|IdentityFile)[[:space:]]+ ]]; then
                local key value
                key=$(echo "$line" | awk '{print $1}')
                value=$(echo "$line" | awk '{$1=""; print $0}' | sed 's/^[[:space:]]*//')
                details+="  $key: $value"$'\n'
            fi
        fi
    done < "$SSH_CONFIG"
    
    echo "$details"
}

# Validate hostname (alphanumeric, dash, underscore, dot)
validate_hostname() {
    local name="$1"
    if [[ ! "$name" =~ ^[a-zA-Z0-9._-]+$ ]]; then
        return 1
    fi
    return 0
}

# Validate IP or hostname
validate_ip_or_hostname() {
    local input="$1"
    
    # If input looks like an IP (only digits and dots), validate as IP
    if [[ "$input" =~ ^[0-9.]+$ ]]; then
        # Must match exactly 4 octets
        if [[ ! "$input" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            return 1
        fi
        IFS='.' read -ra ADDR <<< "$input"
        # Each part must be 0-255
        for i in "${ADDR[@]}"; do
            if [[ $i -gt 255 ]]; then
                return 1
            fi
        done
        return 0
    fi
    
    # Check if it's a valid hostname/FQDN
    if [[ "$input" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$ ]]; then
        return 0
    fi
    
    return 1
}

# Validate port number
validate_port() {
    local port="$1"
    if [[ ! "$port" =~ ^[0-9]+$ ]] || [[ $port -lt 1 ]] || [[ $port -gt 65535 ]]; then
        return 1
    fi
    return 0
}

# Check if host exists in config
host_exists() {
    local hostname="$1"
    grep -q "^Host ${hostname}$" "$SSH_CONFIG" 2>/dev/null
}

# Create backup of SSH config
backup_ssh_config() {
    if [[ -f "$SSH_CONFIG" ]]; then
        cp "$SSH_CONFIG" "$SSH_CONFIG_BACKUP"
        echo -e "${GREEN}âœ“${RESET} Backup created: ${DIM}${SSH_CONFIG_BACKUP}${RESET}"
    fi
}

# Add new host wizard
add_host_wizard() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              â•  Add New SSH Host                        â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    # Host alias
    local hostname
    while true; do
        echo -e "${BOLD}Host alias:${RESET} ${DIM}(e.g., pihole, jellyfin, proxmox)${RESET}"
        read -r -p "> " hostname
        
        if [[ -z "$hostname" ]]; then
            echo -e "${RED}âœ— Host alias cannot be empty${RESET}"
            continue
        fi
        
        if ! validate_hostname "$hostname"; then
            echo -e "${RED}âœ— Invalid hostname. Use only: a-z A-Z 0-9 . - _${RESET}"
            continue
        fi
        
        if host_exists "$hostname"; then
            echo -e "${RED}âœ— Host '$hostname' already exists${RESET}"
            continue
        fi
        
        break
    done
    
    echo ""
    
    # HostName (IP or FQDN)
    local target
    while true; do
        echo -e "${BOLD}IP address or hostname:${RESET} ${DIM}(e.g., 192.168.1.100 or server.local)${RESET}"
        read -r -p "> " target
        
        if [[ -z "$target" ]]; then
            echo -e "${RED}âœ— Target cannot be empty${RESET}"
            continue
        fi
        
        if ! validate_ip_or_hostname "$target"; then
            echo -e "${RED}âœ— Invalid IP address or hostname${RESET}"
            continue
        fi
        
        break
    done
    
    echo ""
    
    # User
    local user
    while true; do
        echo -e "${BOLD}Username:${RESET} ${DIM}(e.g., root, admin, ubuntu)${RESET}"
        read -r -p "> " user
        
        if [[ -z "$user" ]]; then
            echo -e "${RED}âœ— Username cannot be empty${RESET}"
            continue
        fi
        
        if ! validate_hostname "$user"; then
            echo -e "${RED}âœ— Invalid username${RESET}"
            continue
        fi
        
        break
    done
    
    echo ""
    
    # Port
    local port
    while true; do
        echo -e "${BOLD}Port:${RESET} ${DIM}(default: 22)${RESET}"
        read -r -p "> " port
        port="${port:-22}"
        
        if ! validate_port "$port"; then
            echo -e "${RED}âœ— Invalid port number (1-65535)${RESET}"
            continue
        fi
        
        break
    done
    
    echo ""
    
    # SSH key (optional)
    local ssh_key
    echo -e "${BOLD}SSH key path:${RESET} ${DIM}(optional, press Enter to skip)${RESET}"
    read -r -p "> " ssh_key
    
    echo ""
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    echo -e "${BOLD}Review configuration:${RESET}"
    echo ""
    echo -e "  ${BOLD}Host:${RESET}       $hostname"
    echo -e "  ${BOLD}HostName:${RESET}   $target"
    echo -e "  ${BOLD}User:${RESET}       $user"
    echo -e "  ${BOLD}Port:${RESET}       $port"
    if [[ -n "$ssh_key" ]]; then
        echo -e "  ${BOLD}SSH Key:${RESET}    $ssh_key"
    fi
    echo ""
    
    if ! confirm_action "Add this host to SSH config?"; then
        echo -e "${YELLOW}âœ— Cancelled${RESET}"
        return 1
    fi
    
    # Backup before adding
    backup_ssh_config
    
    # Add host to config
    {
        echo ""
        echo "Host $hostname"
        echo "  HostName $target"
        echo "  User $user"
        echo "  Port $port"
        if [[ -n "$ssh_key" ]]; then
            echo "  IdentityFile $ssh_key"
        fi
    } >> "$SSH_CONFIG"
    
    echo ""
    echo -e "${GREEN}âœ“ Host '$hostname' added successfully${RESET}"
    sleep 2
    return 0
}

# View host details
view_host() {
    local hostname="$1"
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              ğŸ“‹  Host Details                            â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    local details
    details=$(get_host_details "$hostname")
    
    if [[ -z "$details" ]]; then
        echo -e "${RED}âœ— Host not found: $hostname${RESET}"
    else
        echo -e "${CYAN}$details${RESET}"
    fi
    
    echo ""
    echo -e "${DIM}Press Enter to continue...${RESET}"
    read -r
}

# Edit host in editor
edit_host_in_editor() {
    local hostname="$1"
    
    if ! host_exists "$hostname"; then
        echo -e "${RED}âœ— Host not found: $hostname${RESET}"
        sleep 2
        return 1
    fi
    
    backup_ssh_config
    
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              âœï¸  Edit Host in Editor                      â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${YELLOW}â†’${RESET} Opening SSH config at host: ${BOLD}$hostname${RESET}"
    echo -e "${DIM}  Find the 'Host $hostname' section and edit as needed${RESET}"
    echo ""
    echo -e "${DIM}Press Enter to open editor...${RESET}"
    read -r
    
    EDITOR="${EDITOR:-nano}"
    $EDITOR "$SSH_CONFIG"
    
    echo ""
    echo -e "${GREEN}âœ“ Changes saved${RESET}"
    sleep 1
    return 0
}

# Delete host
delete_host() {
    local hostname="$1"
    
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              ğŸ—‘ï¸  Delete Host                             â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    local details
    details=$(get_host_details "$hostname")
    
    if [[ -z "$details" ]]; then
        echo -e "${RED}âœ— Host not found: $hostname${RESET}"
        sleep 2
        return 1
    fi
    
    echo -e "${CYAN}$details${RESET}"
    echo ""
    
    if ! confirm_action "Delete host '$hostname'?"; then
        echo -e "${YELLOW}âœ— Cancelled${RESET}"
        sleep 1
        return 1
    fi
    
    backup_ssh_config
    
    # Delete host block using awk
    awk -v host="$hostname" '
    BEGIN { in_host=0 }
    /^Host / {
        if ($2 == host) {
            in_host=1
            next
        } else {
            in_host=0
        }
    }
    in_host == 0 { print }
    ' "$SSH_CONFIG" > "${SSH_CONFIG}.tmp"
    
    mv "${SSH_CONFIG}.tmp" "$SSH_CONFIG"
    
    echo ""
    echo -e "${GREEN}âœ“ Host '$hostname' deleted${RESET}"
    sleep 2
    return 0
}

# Copy host
copy_host() {
    local hostname="$1"
    
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              ğŸ“‹  Copy Host                               â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    if ! host_exists "$hostname"; then
        echo -e "${RED}âœ— Host not found: $hostname${RESET}"
        sleep 2
        return 1
    fi
    
    # Find next available copy number
    local counter=1
    local new_name="${hostname}-copy${counter}"
    while host_exists "$new_name"; do
        ((counter++))
        new_name="${hostname}-copy${counter}"
    done
    
    echo -e "${BOLD}Source host:${RESET} $hostname"
    echo -e "${BOLD}New name:${RESET}    $new_name"
    echo ""
    
    if ! confirm_action "Copy host '$hostname' to '$new_name'?"; then
        echo -e "${YELLOW}âœ— Cancelled${RESET}"
        sleep 1
        return 1
    fi
    
    backup_ssh_config
    
    # Extract host block and append with new name
    local host_block
    host_block=$(awk -v host="$hostname" '
    /^Host / {
        if ($2 == host) {
            in_host=1
            print
            next
        } else {
            in_host=0
        }
    }
    in_host == 1 {
        if (/^Host /) {
            in_host=0
        } else {
            print
        }
    }
    ' "$SSH_CONFIG")
    
    {
        echo ""
        echo "Host $new_name"
        echo "$host_block" | grep -v "^Host "
    } >> "$SSH_CONFIG"
    
    echo ""
    echo -e "${GREEN}âœ“ Host copied to '$new_name'${RESET}"
    sleep 2
    return 0
}

# Search/filter hosts
search_hosts() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              ğŸ”  Search Hosts                            â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    echo -e "${BOLD}Search pattern:${RESET} ${DIM}(case-insensitive)${RESET}"
    read -r -p "> " pattern
    
    if [[ -z "$pattern" ]]; then
        return 0
    fi
    
    echo ""
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    
    local hosts found=0
    hosts=$(get_all_hosts)
    
    while IFS= read -r host; do
        if [[ "$host" =~ $pattern ]] || [[ "${host,,}" =~ ${pattern,,} ]]; then
            echo -e "${GREEN}â€¢${RESET} $host"
            ((found++))
        fi
    done <<< "$hosts"
    
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    echo -e "${BOLD}Found:${RESET} $found host(s)"
    echo ""
    echo -e "${DIM}Press Enter to continue...${RESET}"
    read -r
}

# Host management menu
host_menu() {
    local hostname="$1"
    
    while true; do
        clear
        echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo -e "â•‘              âš™ï¸  Manage Host: ${hostname}$(printf '%*s' $((38-${#hostname})) '')â•‘"
        echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        
        local options=(
            "View host details"
            "Edit host in editor"
            "Delete host"
            "Copy host"
            "â† Back to host list"
        )
        
        local choice
        choose_menu "ğŸ“‹ Host Options" "${options[@]}"
        choice="$HLT_MENU_RESULT"
        
        if [[ "$choice" == "-1" ]]; then
            return 0
        fi
        
        case "$choice" in
            0) view_host "$hostname" ;;
            1) edit_host_in_editor "$hostname" ;;
            2) 
                delete_host "$hostname"
                return 0  # Return after delete
                ;;
            3) copy_host "$hostname" ;;
            4) return 0 ;;
        esac
    done
}

# Export host list
export_host_list() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              ğŸ“¤  Export Host List                        â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    local export_file
    export_file="$HOME/ssh-hosts-export-$(date +%Y%m%d-%H%M%S).txt"
    
    {
        echo "SSH Hosts Export - $(date)"
        echo "================================"
        echo ""
        
        local hosts
        hosts=$(get_all_hosts)
        
        while IFS= read -r host; do
            echo "Host: $host"
            get_host_details "$host" | tail -n +2
            echo ""
        done <<< "$hosts"
    } > "$export_file"
    
    echo -e "${GREEN}âœ“ Host list exported to:${RESET}"
    echo -e "  ${CYAN}$export_file${RESET}"
    echo ""
    echo -e "${DIM}Press Enter to continue...${RESET}"
    read -r
}

# Backup SSH config with timestamp
backup_ssh_config_timestamped() {
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              ğŸ’¾  Backup SSH Config                       â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    
    local backup_file
    backup_file="$HOME/.ssh/config.backup-$(date +%Y%m%d-%H%M%S)"
    cp "$SSH_CONFIG" "$backup_file"
    
    echo -e "${GREEN}âœ“ Backup created:${RESET}"
    echo -e "  ${CYAN}$backup_file${RESET}"
    echo ""
    echo -e "${DIM}Press Enter to continue...${RESET}"
    read -r
}

# Batch delete hosts
batch_delete_hosts() {
    local hosts
    hosts=$(get_all_hosts)
    
    if [[ -z "$hosts" ]]; then
        echo -e "${YELLOW}No hosts configured${RESET}"
        sleep 2
        return 0
    fi
    
    # Build host array
    local -a host_array=()
    local -a selected=()
    while IFS= read -r host; do
        host_array+=("$host")
        selected+=(0)  # 0 = not selected, 1 = selected
    done <<< "$hosts"
    
    local current=0
    local total=${#host_array[@]}
    
    # Interactive checkbox menu
    while true; do
        clear
        echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo -e "â•‘              ğŸ—‘ï¸  Batch Delete Hosts                      â•‘"
        echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        echo -e "${DIM}â†‘/â†“ Navigate  â”‚  Space: Toggle  â”‚  Enter: Confirm  â”‚  q: Cancel${RESET}"
        echo ""
        
        # Count selected
        local selected_count=0
        for s in "${selected[@]}"; do
            if [[ $s -eq 1 ]]; then
                selected_count=$((selected_count + 1))
            fi
        done
        
        echo -e "${BOLD}Select hosts to delete:${RESET} ${YELLOW}($selected_count selected)${RESET}"
        echo ""
        
        # Display hosts with checkboxes
        for i in "${!host_array[@]}"; do
            local checkbox
            if [[ ${selected[$i]} -eq 1 ]]; then
                checkbox="${RED}[x]${RESET}"
            else
                checkbox="[ ]"
            fi
            
            if [[ $i -eq $current ]]; then
                echo -e "  ${CYAN}â–º${RESET} $checkbox ${BOLD}${host_array[$i]}${RESET}"
            else
                echo -e "    $checkbox ${host_array[$i]}"
            fi
        done
        
        echo ""
        
        # Read key
        local key
        IFS= read -rsn1 key < /dev/tty 2>/dev/null || read -rsn1 key
        
        case "$key" in
            $'\x1b')  # Escape sequence
                read -rsn2 -t 0.1 key2 < /dev/tty 2>/dev/null || read -rsn2 -t 0.1 key2
                case "$key2" in
                    '[A')  # Up arrow
                        if [[ $current -gt 0 ]]; then
                            current=$((current - 1))
                        fi
                        ;;
                    '[B')  # Down arrow
                        if [[ $current -lt $((total - 1)) ]]; then
                            current=$((current + 1))
                        fi
                        ;;
                esac
                ;;
            ' ')  # Space - toggle selection
                if [[ ${selected[$current]} -eq 0 ]]; then
                    selected[$current]=1
                else
                    selected[$current]=0
                fi
                ;;
            'j')  # Vim down
                if [[ $current -lt $((total - 1)) ]]; then
                    current=$((current + 1))
                fi
                ;;
            'k')  # Vim up
                if [[ $current -gt 0 ]]; then
                    current=$((current - 1))
                fi
                ;;
            'a'|'A')  # Select all
                for i in "${!selected[@]}"; do
                    selected[$i]=1
                done
                ;;
            'n'|'N')  # Select none
                for i in "${!selected[@]}"; do
                    selected[$i]=0
                done
                ;;
            'q'|'Q')  # Quit
                return 0
                ;;
            '')  # Enter - confirm
                break
                ;;
        esac
    done
    
    # Build list of hosts to delete
    local -a hosts_to_delete=()
    for i in "${!host_array[@]}"; do
        if [[ ${selected[$i]} -eq 1 ]]; then
            hosts_to_delete+=("${host_array[$i]}")
        fi
    done
    
    if [[ ${#hosts_to_delete[@]} -eq 0 ]]; then
        echo -e "${YELLOW}No hosts selected${RESET}"
        sleep 1
        return 0
    fi
    
    # Show confirmation
    clear
    echo -e "${BOLD}${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘              âš ï¸  Confirm Deletion                        â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}The following ${#hosts_to_delete[@]} host(s) will be deleted:${RESET}"
    echo ""
    for host in "${hosts_to_delete[@]}"; do
        echo -e "  ${RED}âœ—${RESET} $host"
    done
    echo ""
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    echo ""
    
    read -rp "$(echo -e "${RED}${BOLD}Type 'DELETE' to confirm: ${RESET}")" confirm
    
    if [[ "$confirm" != "DELETE" ]]; then
        echo -e "${YELLOW}âœ— Cancelled${RESET}"
        sleep 1
        return 0
    fi
    
    backup_ssh_config
    
    local deleted=0
    for host in "${hosts_to_delete[@]}"; do
        if host_exists "$host"; then
            # Delete using awk
            awk -v host="$host" '
            BEGIN { in_host=0 }
            /^Host / {
                if ($2 == host) {
                    in_host=1
                    next
                } else {
                    in_host=0
                }
            }
            in_host == 0 { print }
            ' "$SSH_CONFIG" > "${SSH_CONFIG}.tmp"
            
            mv "${SSH_CONFIG}.tmp" "$SSH_CONFIG"
            deleted=$((deleted + 1))
            echo -e "  ${GREEN}âœ“${RESET} Deleted: $host"
        fi
    done
    
    echo ""
    echo -e "${GREEN}âœ“ Deleted $deleted host(s)${RESET}"
    sleep 2
}

# Bulk operations menu
bulk_operations_menu() {
    while true; do
        clear
        echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo -e "â•‘              ğŸ“¦  Bulk Operations                         â•‘"
        echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        
        local options=(
            "Export host list to file"
            "Backup SSH config (timestamped)"
            "Batch delete hosts"
            "â† Back to main menu"
        )
        
        local choice
        choose_menu "ğŸ“¦ Bulk Operations" "${options[@]}"
        choice="$HLT_MENU_RESULT"
        
        if [[ "$choice" == "-1" ]]; then
            return 0
        fi
        
        case "$choice" in
            0) export_host_list ;;
            1) backup_ssh_config_timestamped ;;
            2) batch_delete_hosts ;;
            3) return 0 ;;
        esac
    done
}

# Main interactive menu
interactive_menu() {
    init_ssh_config
    
    while true; do
        local hosts
        hosts=$(get_all_hosts)
        local host_count
        host_count=$(echo "$hosts" | grep -c "." || echo "0")
        
        # Build menu options with host count in the title
        local menu_title="ğŸ”§ SSH Host Configuration Manager (${host_count} hosts)"
        
        local options=(
            "â• Add new host"
            "ğŸ“‹ Manage existing host"
            "ğŸ” Search hosts"
            "ğŸ“¦ Bulk operations"
            "âœï¸  Open SSH config in editor"
            "â† Exit"
        )
        
        local choice
        choose_menu "$menu_title" "${options[@]}"
        choice="$HLT_MENU_RESULT"
        
        if [[ "$choice" == "-1" ]]; then
            clear
            echo -e "${GREEN}âœ“ Goodbye!${RESET}"
            exit 0
        fi
        
        case "$choice" in
            0) add_host_wizard ;;
            1)
                if [[ $host_count -eq 0 ]]; then
                    echo -e "${YELLOW}No hosts configured yet${RESET}"
                    sleep 2
                    continue
                fi
                
                # Show host selection menu
                clear
                echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo -e "â•‘              ğŸ“‹  Select Host                             â•‘"
                echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
                echo ""
                
                local host_array=()
                while IFS= read -r host; do
                    host_array+=("$host")
                done <<< "$hosts"
                host_array+=("â† Back")
                
                local host_choice
                choose_menu "ğŸ“‹ Select Host" "${host_array[@]}"
                host_choice="$HLT_MENU_RESULT"
                
                if [[ "$host_choice" != "-1" ]] && [[ $host_choice -lt $((${#host_array[@]}-1)) ]]; then
                    host_menu "${host_array[$host_choice]}"
                fi
                ;;
            2) search_hosts ;;
            3) bulk_operations_menu ;;
            4)
                clear
                echo -e "${YELLOW}â†’${RESET} Opening SSH config in editor..."
                EDITOR="${EDITOR:-nano}"
                backup_ssh_config
                $EDITOR "$SSH_CONFIG"
                echo -e "${GREEN}âœ“ Changes saved${RESET}"
                sleep 1
                ;;
            5)
                clear
                echo -e "${GREEN}âœ“ Goodbye!${RESET}"
                exit 0
                ;;
        esac
    done
}

# Main execution
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

if [[ "${1:-}" == "--edit" ]]; then
    # Classic mode: just open in editor
    init_ssh_config
    backup_ssh_config
    EDITOR="${EDITOR:-nano}"
    $EDITOR "$SSH_CONFIG"
    echo -e "${GREEN}âœ“ Changes saved${RESET}"
    exit 0
fi

# Run interactive menu
interactive_menu
