#!/bin/bash
set -euo pipefail

# Bulk generate MOTD templates for all hosts
# Author: J.Bakers
# Version: 4.0.0

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

SSH_CONFIG="$HOME/.ssh/config"
TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"

show_help() {
    echo -e "${BOLD}${CYAN}bulk-generate-motd - Generate MOTDs for all hosts${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  bulk-generate-motd          # Interactive mode"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Generates MOTD templates for all hosts in SSH config."
    echo "  Choose between Default clean or ASCII art styles."
    echo "  Use Interactive mode to customize each host individually,"
    echo "  or Smart-detect mode for automatic generation."
    echo ""
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

# Main loop for returning to menu
while true; do
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ“ Bulk MOTD Generator                           â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Check SSH config
    if [[ ! -f "$SSH_CONFIG" ]]; then
        echo -e "${RED}âœ— SSH config not found: $SSH_CONFIG${RESET}"
        echo ""
        echo -e "  Create it first with:"
        echo -e "  ${GREEN}edit-ssh${RESET}"
        exit 1
    fi

    # Create templates directory
    mkdir -p "$TEMPLATES_DIR"

    # Read all hosts from SSH config
    hosts=$(grep "^Host " "$SSH_CONFIG" | awk '{print $2}' | grep -v '\*' | sort -u)
    host_count=$(echo "$hosts" | wc -l)

    if [[ $host_count -eq 0 ]]; then
        echo -e "${YELLOW}âš  No hosts found in SSH config${RESET}"
        echo ""
        echo -e "  Add hosts with:"
        echo -e "  ${GREEN}edit-ssh${RESET}"
        exit 0
    fi

    echo -e "${BOLD}Found ${GREEN}$host_count${RESET} ${BOLD}hosts in SSH config${RESET}"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Step 1: Choose style type
    echo -e "${BOLD}${CYAN}Step 1: Choose MOTD Style${RESET}"
    echo ""
    echo -e "  ${GREEN}D${RESET}) ${BOLD}Default Clean MOTD${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Functional & informative, no ASCII art"
    echo ""
    echo -e "  ${GREEN}A${RESET}) ${BOLD}ASCII Art MOTD${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Choose from 6 artistic styles"
    echo ""
    read -p "$(echo -e ${CYAN}Choose style type \(D/a\):${RESET} )" style_type
    style_type=${style_type:-D}
    style_type=$(echo "$style_type" | tr '[:lower:]' '[:upper:]')

    # ASCII style selection
    ascii_style=""
    if [[ "$style_type" == "A" ]]; then
        echo ""
        echo -e "${BOLD}${CYAN}ASCII Art Styles:${RESET}"
        echo ""

        if command -v toilet &> /dev/null; then
            echo -e "  ${CYAN}1${RESET}) Clean & Functional ${YELLOW}(No ASCII - Default)${RESET}"
            echo -e "  ${CYAN}2${RESET}) Rainbow Future    ${YELLOW}(Colorful, modern)${RESET}"
            echo -e "  ${CYAN}3${RESET}) Rainbow Standard  ${YELLOW}(Colorful, classic)${RESET}"
            echo -e "  ${CYAN}4${RESET}) Mono Future       ${YELLOW}(Black & white, modern)${RESET}"
            echo -e "  ${CYAN}5${RESET}) Big Mono          ${YELLOW}(Large, bold)${RESET}"
            echo -e "  ${CYAN}6${RESET}) Small/Smblock     ${YELLOW}(Compact)${RESET}"
            echo ""
            read -p "$(echo -e ${CYAN}Choose ASCII style \(1-6\):${RESET} )" ascii_style
            ascii_style=${ascii_style:-1}
        else
            echo -e "${YELLOW}âš  Toilet not installed - ASCII art not available${RESET}"
            echo -e "  For ASCII art: ${GREEN}sudo apt install toilet toilet-fonts${RESET}"
            echo -e "  Falling back to Clean & Functional style"
            echo ""
            ascii_style="1"
        fi
    else
        # Default style = style 1 (clean)
        ascii_style="1"
    fi

    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Step 2: Choose generation mode
    echo -e "${BOLD}${CYAN}Step 2: Choose Generation Mode${RESET}"
    echo ""
    echo -e "  ${GREEN}I${RESET}) ${BOLD}Interactive Mode${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Customize each host individually"
    echo -e "     ${YELLOW}â†’${RESET} Choose service name, description, web UI per host"
    echo ""
    echo -e "  ${GREEN}S${RESET}) ${BOLD}Smart-Detect Mode${RESET} ${GREEN}[Recommended]${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Automatic generation for all hosts"
    echo -e "     ${YELLOW}â†’${RESET} Uses chosen style with auto-detected settings"
    echo -e "     ${YELLOW}â†’${RESET} No prompts per host"
    echo ""
    read -p "$(echo -e ${CYAN}Choose mode \(i/S\):${RESET} )" gen_mode
    gen_mode=${gen_mode:-S}
    gen_mode=$(echo "$gen_mode" | tr '[:lower:]' '[:upper:]')

    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Show what will happen
    if [[ "$gen_mode" == "I" ]]; then
        echo -e "${YELLOW}â†’${RESET} ${BOLD}Starting Interactive Mode...${RESET}"
        echo -e "  You will be prompted to customize each host individually"
    else
        echo -e "${GREEN}âœ“${RESET} ${BOLD}Starting Smart-Detect Mode...${RESET}"
        if [[ "$ascii_style" == "1" ]]; then
            echo -e "  Generating all hosts with ${CYAN}Clean & Functional${RESET} style"
        else
            echo -e "  Generating all hosts with ${CYAN}ASCII style $ascii_style${RESET}"
        fi
        echo -e "  Auto-detecting settings for each host"
    fi
    echo ""

    # Counters
    generated=0
    skipped=0
    failed=0

    # Loop through hosts
    for hostname in $hosts; do
        template_file="$TEMPLATES_DIR/${hostname}.sh"

        echo -e "${BOLD}${CYAN}Host: ${hostname}${RESET}"

        # Check if template exists
        if [[ -f "$template_file" ]]; then
            echo -e "  ${YELLOW}âš ${RESET} Template already exists"

            if [[ "$gen_mode" == "S" ]]; then
                # Smart mode: always overwrite
                echo -e "  ${GREEN}âœ“${RESET} Overwriting (Smart-detect mode)"
            else
                # Interactive mode: ask
                read -p "  Overwrite? (Y/n): " overwrite
                overwrite=${overwrite:-y}
                if [[ ! "$overwrite" =~ ^[Yy]$ ]]; then
                    echo -e "  ${YELLOW}â†’${RESET} Skipped"
                    ((skipped++))
                    echo ""
                    continue
                fi
            fi
        fi

        # Generate based on mode
        if [[ "$gen_mode" == "S" ]]; then
            # Smart-detect mode: auto-generate with chosen style
            echo -e "  ${YELLOW}â†’${RESET} Auto-generating..."

            # Prepare input for generate-motd:
            # - customize=n (use auto-detection)
            # - style=$ascii_style
            # - deploy=n (we'll do bulk deploy later)
            echo -e "n\n${ascii_style}\nn\n" | generate-motd "$hostname" &>/dev/null

            if [[ -f "$template_file" ]]; then
                echo -e "  ${GREEN}âœ“${RESET} Generated successfully"
                ((generated++))
            else
                echo -e "  ${RED}âœ—${RESET} Generation failed"
                ((failed++))
            fi
        else
            # Interactive mode: call generate-motd interactively
            echo -e "  ${YELLOW}â†’${RESET} Interactive customization..."
            echo ""

            # Pre-fill with chosen ASCII style, but let user customize
            # The user can still change everything in generate-motd
            # We'll pass: customize=y, style=$ascii_style, and let them customize
            echo -e "y\n${ascii_style}\nn\n" | generate-motd "$hostname"

            if [[ -f "$template_file" ]]; then
                echo -e "  ${GREEN}âœ“${RESET} Generated"
                ((generated++))
            else
                echo -e "  ${YELLOW}â†’${RESET} Skipped or failed"
                ((skipped++))
            fi
        fi

        echo ""
    done

    # Summary
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${BOLD}${CYAN}                 Generation Summary                        ${RESET}"
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${GREEN}âœ“ Generated:${RESET} $generated"
    echo -e "${YELLOW}â†’ Skipped:${RESET}   $skipped"
    if [[ $failed -gt 0 ]]; then
        echo -e "${RED}âœ— Failed:${RESET}    $failed"
    fi
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Bulk deploy option
    if [[ $generated -gt 0 ]]; then
        echo -e "${BOLD}${CYAN}Step 3: Deployment${RESET}"
        echo ""
        echo -e "  ${GREEN}âœ“${RESET} Templates generated successfully!"
        echo ""
        echo -e "${BOLD}Deploy all generated MOTDs to hosts now?${RESET}"
        echo ""
        echo -e "  ${GREEN}Y${RESET}) Yes, deploy now via SSH"
        echo -e "  ${GREEN}N${RESET}) No, I'll deploy manually later"
        echo ""
        read -p "$(echo -e ${CYAN}Deploy now? \(Y/n\):${RESET} )" deploy_all
        deploy_all=${deploy_all:-y}

        if [[ "$deploy_all" =~ ^[Yy]$ ]]; then
            echo ""
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo -e "${BOLD}${CYAN}                   ğŸš€ Deploying MOTDs                       ${RESET}"
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""

            deployed=0
            deploy_failed=0

            for hostname in $hosts; do
                template_file="$TEMPLATES_DIR/${hostname}.sh"

                # Only deploy if template exists
                if [[ -f "$template_file" ]]; then
                    echo -e "${BOLD}${CYAN}Deploying to: ${hostname}${RESET}"

                    if deploy-motd "$hostname" &>/dev/null; then
                        echo -e "  ${GREEN}âœ“${RESET} Deployed successfully"
                        ((deployed++))
                    else
                        echo -e "  ${RED}âœ—${RESET} Deployment failed"
                        ((deploy_failed++))
                    fi
                fi
            done

            echo ""
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo -e "${BOLD}${CYAN}                Deployment Summary                         ${RESET}"
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""
            echo -e "${GREEN}âœ“ Deployed:${RESET} $deployed"
            if [[ $deploy_failed -gt 0 ]]; then
                echo -e "${RED}âœ— Failed:${RESET}   $deploy_failed"
            fi
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""
        else
            echo ""
            echo -e "${BOLD}${YELLOW}Manual Deployment Instructions:${RESET}"
            echo ""
            echo -e "  Templates have been generated but not deployed."
            echo -e "  To deploy them manually, use one of these methods:"
            echo ""
            echo -e "  ${BOLD}1. Deploy individual hosts:${RESET}"
            echo -e "     ${GREEN}deploy-motd <hostname>${RESET}"
            echo -e "     Example: ${GREEN}deploy-motd jellyfin${RESET}"
            echo ""
            echo -e "  ${BOLD}2. View all templates:${RESET}"
            echo -e "     ${GREEN}list-templates${RESET}"
            echo ""
            echo -e "  ${BOLD}3. Run this tool again:${RESET}"
            echo -e "     ${GREEN}bulk-generate-motd${RESET}"
            echo -e "     (Will skip existing templates)"
            echo ""
        fi
    fi

    # Return to menu or exit
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}What would you like to do next?${RESET}"
    echo ""
    echo -e "  ${GREEN}M${RESET}) Return to main menu (generate more)"
    echo -e "  ${GREEN}Q${RESET}) Quit"
    echo ""
    read -p "$(echo -e ${CYAN}Choice \(m/Q\):${RESET} )" next_action
    next_action=${next_action:-Q}
    next_action=$(echo "$next_action" | tr '[:lower:]' '[:upper:]')

    if [[ "$next_action" == "M" ]]; then
        continue
    else
        echo ""
        echo -e "${GREEN}âœ“${RESET} Done! Have a great day!"
        echo ""
        break
    fi
done
