#!/bin/bash
set -euo pipefail

# Bulk generate MOTD templates for all hosts
# Author: J.Bakers
# Version: 3.5.0-dev.16

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

SSH_CONFIG="$HOME/.ssh/config"
TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"

# Systems that don't support MOTD (appliances, Docker, non-Linux)
UNSUPPORTED_SYSTEMS=(
    "homeassistant" "hass" "ha"           # Home Assistant (Docker)
    "truenas"                              # TrueNAS (FreeBSD appliance)
    "pfsense" "opnsense"                   # Firewall appliances
    "windows" "win"                        # Windows systems
    "unraid"                               # Unraid (different MOTD)
    "synology" "nas"                       # Synology NAS
    "qnap"                                 # QNAP NAS
)

show_help() {
    echo -e "${BOLD}${CYAN}bulk-generate-motd - Generate MOTDs for all hosts${RESET}"
    echo ""
    echo -e "${BOLD}USAGE:${RESET}"
    echo "  bulk-generate-motd          # Interactive mode"
    echo ""
    echo -e "${BOLD}DESCRIPTION:${RESET}"
    echo "  Generates MOTD templates for all hosts in SSH config."
    echo "  Choose between Default clean or ASCII art styles."
    echo "  Use Interactive mode to customize each host individually,"
    echo "  or Smart-detect mode for automatic generation."
    echo ""
}

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    show_help
    exit 0
fi

# Main loop for returning to menu
while true; do
    clear
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ“ Bulk MOTD Generator                           â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Check SSH config
    if [[ ! -f "$SSH_CONFIG" ]]; then
        echo -e "${RED}âœ— SSH config not found: $SSH_CONFIG${RESET}"
        echo ""
        echo -e "  Create it first with:"
        echo -e "  ${GREEN}edit-ssh${RESET}"
        exit 1
    fi

    # Create templates directory
    mkdir -p "$TEMPLATES_DIR"

    # Read all hosts from SSH config
    hosts=$(grep "^Host " "$SSH_CONFIG" | awk '{print $2}' | grep -v '\*' | sort -u)
    host_count=$(echo "$hosts" | wc -l)

    if [[ $host_count -eq 0 ]]; then
        echo -e "${YELLOW}âš  No hosts found in SSH config${RESET}"
        echo ""
        echo -e "  Add hosts with:"
        echo -e "  ${GREEN}edit-ssh${RESET}"
        exit 0
    fi

    echo -e "${BOLD}Found ${GREEN}$host_count${RESET} ${BOLD}hosts in SSH config${RESET}"
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Step 1: Choose style type
    echo -e "${BOLD}${CYAN}Step 1: Choose MOTD Style${RESET}"
    echo ""
    echo -e "  ${YELLOW}1${RESET}) ${BOLD}Default Clean MOTD${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Functional & informative, no ASCII art"
    echo ""
    echo -e "  ${YELLOW}2${RESET}) ${BOLD}ASCII Art MOTD${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Choose from 6 artistic styles"
    echo ""
    read -p "$(echo -e ${CYAN}Choice \(1/2\):${RESET} )" style_type
    style_type=${style_type:-1}

    # ASCII style selection with preview
    ascii_style=""
    if [[ "$style_type" == "2" ]]; then
        echo ""
        echo -e "${BOLD}${CYAN}ASCII Art Styles:${RESET}"
        echo ""

        if command -v toilet &> /dev/null; then
            while true; do
                echo -e "  ${CYAN}1${RESET}) Clean & Functional ${YELLOW}(No ASCII - Default)${RESET}"
                echo -e "  ${CYAN}2${RESET}) Rainbow Future    ${YELLOW}(Colorful, modern)${RESET}"
                echo -e "  ${CYAN}3${RESET}) Rainbow Standard  ${YELLOW}(Colorful, classic)${RESET}"
                echo -e "  ${CYAN}4${RESET}) Mono Future       ${YELLOW}(Black & white, modern)${RESET}"
                echo -e "  ${CYAN}5${RESET}) Big Mono          ${YELLOW}(Large, bold)${RESET}"
                echo -e "  ${CYAN}6${RESET}) Small/Smblock     ${YELLOW}(Compact)${RESET}"
                echo ""
                read -p "$(echo -e ${CYAN}Choose ASCII style \(1-6, p for preview\):${RESET} )" ascii_choice
                ascii_choice=${ascii_choice:-1}

                # Handle preview
                if [[ "$ascii_choice" == "p" ]] || [[ "$ascii_choice" == "P" ]]; then
                    clear
                    echo -e "${BOLD}${CYAN}ASCII Art Preview${RESET}"
                    echo ""
                    toilet -f future --gay "TEST" 2>/dev/null || echo "Style 2: Rainbow Future"
                    echo ""
                    toilet -f standard --gay "TEST" 2>/dev/null || echo "Style 3: Rainbow Standard"
                    echo ""
                    toilet -f future "TEST" 2>/dev/null || echo "Style 4: Mono Future"
                    echo ""
                    toilet -f bigmono9 "TEST" 2>/dev/null || echo "Style 5: Big Mono"
                    echo ""
                    toilet -f smblock "TEST" 2>/dev/null || echo "Style 6: Small/Smblock"
                    echo ""
                    read -p "$(echo -e ${YELLOW}Press Enter to continue...${RESET})"
                    clear
                    echo -e "${BOLD}${CYAN}ASCII Art Styles:${RESET}"
                    echo ""
                    continue
                fi

                # Validate choice
                if [[ "$ascii_choice" =~ ^[1-6]$ ]]; then
                    ascii_style="$ascii_choice"
                    break
                else
                    echo -e "${RED}Invalid choice. Please enter 1-6 or 'p' for preview.${RESET}"
                    sleep 1
                    clear
                    echo -e "${BOLD}${CYAN}ASCII Art Styles:${RESET}"
                    echo ""
                fi
            done
        else
            echo -e "${YELLOW}âš  Toilet not installed - ASCII art not available${RESET}"
            echo -e "  For ASCII art: ${GREEN}sudo apt install toilet toilet-fonts${RESET}"
            echo -e "  Falling back to Clean & Functional style"
            echo ""
            ascii_style="1"
        fi
    else
        # Default style = style 1 (clean)
        ascii_style="1"
    fi

    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Step 2: Choose generation mode
    echo -e "${BOLD}${CYAN}Step 2: Choose Generation Mode${RESET}"
    echo ""
    echo -e "  ${YELLOW}1${RESET}) ${BOLD}Interactive Mode${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Customize each host individually"
    echo -e "     ${YELLOW}â†’${RESET} Choose service name, description, web UI per host"
    echo ""
    echo -e "  ${YELLOW}2${RESET}) ${BOLD}Smart-Detect Mode${RESET} ${GREEN}[Recommended]${RESET}"
    echo -e "     ${YELLOW}â†’${RESET} Automatic generation for all hosts"
    echo -e "     ${YELLOW}â†’${RESET} Uses chosen style with auto-detected settings"
    echo -e "     ${YELLOW}â†’${RESET} No prompts per host"
    echo ""
    read -p "$(echo -e ${CYAN}Choice \(1/2\):${RESET} )" gen_mode
    gen_mode=${gen_mode:-2}

    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Show what will happen
    if [[ "$gen_mode" == "1" ]]; then
        echo -e "${YELLOW}â†’${RESET} ${BOLD}Starting Interactive Mode...${RESET}"
        echo -e "  You will be prompted to customize each host individually"
    else
        echo -e "${GREEN}âœ“${RESET} ${BOLD}Starting Smart-Detect Mode...${RESET}"
        if [[ "$ascii_style" == "1" ]]; then
            echo -e "  Generating all hosts with ${CYAN}Clean & Functional${RESET} style"
        else
            echo -e "  Generating all hosts with ${CYAN}ASCII style $ascii_style${RESET}"
        fi
        echo -e "  Auto-detecting settings for each host"
    fi
    echo ""

    # Counters
    generated=0
    skipped=0
    failed=0

    # Loop through hosts
    for hostname in $hosts; do
        template_file="$TEMPLATES_DIR/${hostname}.sh"

        echo -e "${BOLD}${CYAN}Host: ${hostname}${RESET}"

        # Check if system is unsupported
        hostname_lower=$(echo "$hostname" | tr '[:upper:]' '[:lower:]')
        is_unsupported=false
        for unsupported in "${UNSUPPORTED_SYSTEMS[@]}"; do
            if [[ "$hostname_lower" == "$unsupported" ]]; then
                echo -e "  ${YELLOW}âš ${RESET} System doesn't support MOTD"
                echo -e "  ${YELLOW}â†’${RESET} Skipped"
                skipped=$((skipped + 1))
                echo ""
                is_unsupported=true
                break
            fi
        done

        # Skip to next host if unsupported
        if [[ "$is_unsupported" == "true" ]]; then
            continue
        fi

        # Check if template exists
        if [[ -f "$template_file" ]]; then
            echo -e "  ${YELLOW}âš ${RESET} Template already exists"

            if [[ "$gen_mode" == "2" ]]; then
                # Smart mode: always overwrite
                echo -e "  ${GREEN}âœ“${RESET} Overwriting (Smart-detect mode)"
            else
                # Interactive mode: ask
                read -p "  Overwrite? (1=Yes, 2=No): " overwrite
                overwrite=${overwrite:-1}
                if [[ "$overwrite" != "1" ]]; then
                    echo -e "  ${YELLOW}â†’${RESET} Skipped"
                    skipped=$((skipped + 1))
                    echo ""
                    continue
                fi
            fi
        fi

        # Generate based on mode
        if [[ "$gen_mode" == "2" ]]; then
            # Smart-detect mode: auto-generate with chosen style
            echo -e "  ${YELLOW}â†’${RESET} Auto-generating..."

            # Prepare input for generate-motd:
            # - customize=n (use auto-detection)
            # - style=$ascii_style
            # - deploy=n (we'll do bulk deploy later)
            # Echo pipe provides input and prevents stdin consumption from loop
            echo -e "n\n${ascii_style}\nn\n" | generate-motd "$hostname" &>/dev/null

            if [[ -f "$template_file" ]]; then
                echo -e "  ${GREEN}âœ“${RESET} Generated successfully"
                generated=$((generated + 1))
            else
                echo -e "  ${RED}âœ—${RESET} Generation failed"
                failed=$((failed + 1))
            fi
        else
            # Interactive mode: call generate-motd interactively
            echo -e "  ${YELLOW}â†’${RESET} Interactive customization..."
            echo ""

            # Pre-fill with chosen ASCII style, but let user customize
            # The user can still change everything in generate-motd
            # We'll pass: customize=y, style=$ascii_style, and let them customize
            # Echo pipe provides input and prevents stdin consumption from loop
            echo -e "y\n${ascii_style}\nn\n" | generate-motd "$hostname"

            if [[ -f "$template_file" ]]; then
                echo -e "  ${GREEN}âœ“${RESET} Generated"
                generated=$((generated + 1))
            else
                echo -e "  ${YELLOW}â†’${RESET} Skipped or failed"
                skipped=$((skipped + 1))
            fi
        fi

        echo ""
    done


    # Summary
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${BOLD}${CYAN}                 Generation Summary                        ${RESET}"
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${GREEN}âœ“ Generated:${RESET} $generated"
    echo -e "${YELLOW}â†’ Skipped:${RESET}   $skipped"
    if [[ $failed -gt 0 ]]; then
        echo -e "${RED}âœ— Failed:${RESET}    $failed"
    fi
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Bulk deploy option
    if [[ $generated -gt 0 ]]; then
        echo -e "${BOLD}${CYAN}Step 3: Deployment${RESET}"
        echo ""
        echo -e "  ${GREEN}âœ“${RESET} Templates generated successfully!"
        echo ""
        echo -e "${BOLD}Deploy all generated MOTDs to hosts now?${RESET}"
        echo ""
        echo -e "  ${YELLOW}1${RESET}) Yes, deploy now via SSH"
        echo -e "  ${YELLOW}2${RESET}) No, I'll deploy manually later"
        echo ""
        read -p "$(echo -e ${CYAN}Choice \(1/2\):${RESET} )" deploy_all
        deploy_all=${deploy_all:-1}

        if [[ "$deploy_all" == "1" ]]; then
            echo ""
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo -e "${BOLD}${CYAN}                   ğŸš€ Deploying MOTDs                       ${RESET}"
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""

            deployed=0
            deploy_failed=0

            for hostname in $hosts; do
                template_file="$TEMPLATES_DIR/${hostname}.sh"

                # Only deploy if template exists
                if [[ -f "$template_file" ]]; then
                    echo -e "${BOLD}${CYAN}Deploying to: ${hostname}${RESET}"

                    if deploy-motd "$hostname" &>/dev/null; then
                        echo -e "  ${GREEN}âœ“${RESET} Deployed successfully"
                        deployed=$((deployed + 1))
                    else
                        echo -e "  ${RED}âœ—${RESET} Deployment failed"
                        deploy_failed=$((deploy_failed + 1))
                    fi
                fi
            done

            echo ""
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo -e "${BOLD}${CYAN}                Deployment Summary                         ${RESET}"
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""
            echo -e "${GREEN}âœ“ Deployed:${RESET} $deployed"
            if [[ $deploy_failed -gt 0 ]]; then
                echo -e "${RED}âœ— Failed:${RESET}   $deploy_failed"
            fi
            echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo ""
        else
            echo ""
            echo -e "${BOLD}${YELLOW}Manual Deployment Instructions:${RESET}"
            echo ""
            echo -e "  Templates have been generated but not deployed."
            echo -e "  To deploy them manually, use one of these methods:"
            echo ""
            echo -e "  ${BOLD}1. Deploy individual hosts:${RESET}"
            echo -e "     ${GREEN}deploy-motd <hostname>${RESET}"
            echo -e "     Example: ${GREEN}deploy-motd jellyfin${RESET}"
            echo ""
            echo -e "  ${BOLD}2. View all templates:${RESET}"
            echo -e "     ${GREEN}list-templates${RESET}"
            echo ""
            echo -e "  ${BOLD}3. Run this tool again:${RESET}"
            echo -e "     ${GREEN}bulk-generate-motd${RESET}"
            echo -e "     (Will skip existing templates)"
            echo ""
        fi
    fi

    # Return to menu or exit
    echo ""
    echo -e "${BOLD}${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}What would you like to do next?${RESET}"
    echo ""
    echo -e "  ${YELLOW}1${RESET}) Return to main menu (generate more)"
    echo -e "  ${YELLOW}2${RESET}) Quit"
    echo ""
    read -p "$(echo -e ${CYAN}Choice \(1/2\):${RESET} )" next_action
    next_action=${next_action:-2}

    if [[ "$next_action" == "1" ]]; then
        continue
    else
        echo ""
        echo -e "${GREEN}âœ“${RESET} Done! Have a great day!"
        echo ""
        break
    fi
done
