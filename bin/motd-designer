#!/bin/bash
set -euo pipefail  # Exit on error, undefined vars, pipe failures

# Load paths and libraries
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
# shellcheck source=../lib/menu-helpers.sh
source "$LIB_DIR/menu-helpers.sh"
# shellcheck source=../lib/validators.sh
source "$LIB_DIR/validators.sh"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'
NC='\033[0m'

TEMPLATES_DIR="$HOME/.local/share/homelab-tools/templates"

# Style mapping
render_ascii() {
    local text="$1"
    local style="$2"
    local font="" filter=""

    case "$style" in
        clean) font="none" ;;
        rainbow_future) font="future"; filter="gay" ;;
        rainbow_standard) font="standard"; filter="gay" ;;
        mono_future) font="future" ;;
        big_mono) font="bigmono9" ;;
        small) font="smblock" ;;
        emboss) font="emboss" ;;
        pagga) font="pagga" ;;
        trek) font="trek" ;;
        term) font="term" ;;
        *) font="none" ;;
    esac

    if [[ "$font" == "none" ]]; then
        echo ""
        return
    fi

    if command -v toilet &> /dev/null; then
        if [[ -n "$filter" ]]; then
            toilet -f "$font" -F "$filter" "$text" 2>/dev/null || true
        else
            toilet -f "$font" "$text" 2>/dev/null || true
        fi
    elif command -v figlet &> /dev/null; then
        figlet "$text" 2>/dev/null || true
    else
        printf "%s\n" "=== $text ==="
    fi
}

validate_template_name() {
    local name="$1"
    if [[ ! "$name" =~ ^[a-zA-Z0-9._-]+$ ]]; then
        echo -e "${RED}✗ Invalid template name${RESET}"
        exit 1
    fi
}

write_template() {
    local name="$1"
    local header="$2"
    local style="$3"
    local blocks="$4"  # comma separated
    local template_path="$TEMPLATES_DIR/$name.sh"

    mkdir -p "$TEMPLATES_DIR"

    local ascii_block=""
    ascii_block=$(render_ascii "$header" "$style")

    cat > "$template_path" <<'EOF'
#!/bin/bash
# === HLT-MOTD-START ===
# Generated by Homelab Tools (https://github.com/JBakers/homelab-tools)
# Do not edit between HLT-MOTD-START and HLT-MOTD-END markers

NC='\033[0m'
CYAN='\033[0;96m'
GREEN='\033[0;92m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
RED='\033[0;91m'
BOLD='\033[1m'
UNDERLINE='\033[4m'
NC='\033[0m'
EOF

    if [[ -n "$ascii_block" ]]; then
        cat >> "$template_path" <<'EOF'
cat <<'__HLT_ASCII__'
EOF
        echo "$ascii_block" >> "$template_path"
        cat >> "$template_path" <<'EOF'
__HLT_ASCII__
echo ""
EOF
    else
        echo "echo -e \"${BOLD}${CYAN}$header${RESET}\"" >> "$template_path"
        echo "echo ''" >> "$template_path"
    fi

    IFS=',' read -ra BLOCKS_ARR <<< "$blocks"
    echo "echo -e \"${GREEN}${BOLD}System Information:${RESET}\"" >> "$template_path"
    echo "echo ''" >> "$template_path"

    for block in "${BLOCKS_ARR[@]}"; do
        case "$block" in
            hostname)
                echo "echo -e \"  ${YELLOW}Hostname:${NC}    $(hostname)\"" >> "$template_path"
                ;;
            ip)
                echo "echo -e \"  ${YELLOW}IP Address:${NC}  $(hostname -I | awk '{print $1}')\"" >> "$template_path"
                ;;
            uptime)
                echo "echo -e \"  ${YELLOW}Uptime:${NC}      $(uptime -p)\"" >> "$template_path"
                ;;
            load)
                echo "echo -e \"  ${YELLOW}Load:${NC}        $(uptime | awk -F 'load average:' '{ print $2 }' | xargs)\"" >> "$template_path"
                ;;
            disk)
                echo "echo -e \"  ${YELLOW}Disk:${NC}        $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')\"" >> "$template_path"
                ;;
        esac
    done

    cat >> "$template_path" <<'EOF'
echo ""
# === HLT-MOTD-END ===
EOF

    chmod +x "$template_path"
    echo -e "${GREEN}✓${RESET} Template created: ${CYAN}$template_path${RESET}"
}

STYLE_LIST=(clean rainbow_future rainbow_standard mono_future big_mono small emboss pagga trek term)

show_style_menu() {
    choose_menu "Choose style" \
        "Clean & Functional|No ASCII" \
        "Rainbow Future|Colorful, modern" \
        "Rainbow Standard|Colorful, classic" \
        "Mono Future|Black & white, modern" \
        "Big Mono|Large, bold" \
        "Small/Smblock|Small, compact" \
        "Emboss|Raised effect" \
        "Pagga Rounded|Rounded dots" \
        "Trek|Sci-fi style" \
        "Term Wide|Terminal wide font"
    if [[ $HLT_MENU_RESULT -eq -1 ]]; then
        echo -e "${YELLOW}Cancelled${RESET}"
        exit 0
    fi
    echo "${STYLE_LIST[$HLT_MENU_RESULT]}"
}

interactive_flow() {
    echo -e "${BOLD}${CYAN}MOTD Designer${RESET}"
    echo ""
    read -r -p "$(echo -e "${CYAN}Template name (service): ${RESET}")" tmpl
    validate_template_name "$tmpl"

    read -r -p "$(echo -e "${CYAN}Header text [${tmpl}]: ${RESET}")" header
    header=${header:-$tmpl}

    echo ""
    echo -e "${YELLOW}→${RESET} Choose style"
    style=$(show_style_menu)

    declare -A block_map=([hostname]=1 [ip]=1 [uptime]=1 [load]=0 [disk]=0)
    for block in hostname ip uptime load disk; do
        choose_menu "Include $block?" "Yes" "No"
        if [[ $HLT_MENU_RESULT -eq 0 ]]; then
            block_map[$block]=1
        else
            block_map[$block]=0
        fi
    done

    selected=()
    for b in hostname ip uptime load disk; do
        if [[ ${block_map[$b]:-0} -eq 1 ]]; then
            selected+=("$b")
        fi
    done
    blocks_csv=$(IFS=,; echo "${selected[*]}")
    [[ -z "$blocks_csv" ]] && blocks_csv="hostname,ip"

    write_template "$tmpl" "$header" "$style" "$blocks_csv"
}

non_interactive_flow() {
    local name="$1" style="$2" header="$3" blocks="$4"
    validate_template_name "$name"
    local found=0
    for s in "${STYLE_LIST[@]}"; do
        if [[ "$s" == "$style" ]]; then
            found=1; break
        fi
    done
    if [[ $found -eq 0 ]]; then
        echo -e "${RED}✗ Invalid style${RESET}: $style"
        exit 1
    fi
    [[ -z "$blocks" ]] && blocks="hostname,ip,uptime"
    write_template "$name" "$header" "$style" "$blocks"
}

usage() {
    cat <<EOF
Usage: motd-designer [--name svc] [--style style] [--header text] [--blocks csv]
Styles: ${STYLE_LIST[*]}
Blocks: hostname,ip,uptime,load,disk
If no args: interactive menu
EOF
}

main() {
    if [[ "${1:-}" == "--help" ]]; then
        usage; exit 0
    fi

    name=""
    style="clean"
    header=""
    blocks=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name) name="$2"; shift 2 ;;
            --style) style="$2"; shift 2 ;;
            --header) header="$2"; shift 2 ;;
            --blocks) blocks="$2"; shift 2 ;;
            *) echo -e "${RED}Unknown flag:$RESET $1"; usage; exit 1 ;;
        esac
    done

    if [[ -t 0 && -z "$name" ]]; then
        interactive_flow
    else
        [[ -z "$name" ]] && { echo -e "${RED}✗ --name required in non-interactive mode${RESET}"; exit 1; }
        [[ -z "$header" ]] && header="$name"
        non_interactive_flow "$name" "$style" "$header" "$blocks"
    fi
}

main "$@"
