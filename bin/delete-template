#!/bin/bash
set -euo pipefail

# Delete MOTD Template
# Author: J.Bakers
# Version: See VERSION file

# Load paths and libraries
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"
# Source menu helpers for choose_menu function
if [[ -f "$LIB_DIR/menu-helpers.sh" ]]; then
    # shellcheck source=/dev/null
    source "$LIB_DIR/menu-helpers.sh"
fi

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

TEMPLATE_DIR="$HOME/.local/share/homelab-tools/templates"

# Show help
show_help() {
    echo ""
    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ—‘ï¸  Delete MOTD Template                          â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}Usage:${RESET}"
    echo "  delete-template [template-name]"
    echo "  delete-template -i                  # Interactive mode"
    echo ""
    echo -e "${BOLD}Examples:${RESET}"
    echo "  delete-template pihole              # Delete pihole.sh"
    echo "  delete-template -i                  # Choose from list"
    echo ""
    echo -e "${BOLD}Template Location:${RESET}"
    echo "  $TEMPLATE_DIR"
    echo ""
}

# Interactive selection
interactive_delete() {
    if [[ ! -d "$TEMPLATE_DIR" ]] || [[ -z "$(ls -A "$TEMPLATE_DIR" 2>/dev/null)" ]]; then
        echo -e "${RED}âœ— No templates found${RESET}"
        echo -e "  Location: ${CYAN}$TEMPLATE_DIR${RESET}"
        return 1
    fi

    echo -e "${BOLD}${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘         ğŸ—‘ï¸  Delete Template                               â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}Available templates:${RESET}"
    echo ""

    local templates=()
    declare -a menu_opts
    while IFS= read -r template; do
        local name="${template%.sh}"
        local size
        local date
        size=$(du -h "$TEMPLATE_DIR/$template" | cut -f1)
        date=$(stat -c %y "$TEMPLATE_DIR/$template" | cut -d' ' -f1)
        templates+=("$name")
        menu_opts+=("$name|$size, $date")
    done < <(find "$TEMPLATE_DIR" -name "*.sh" -type f -exec basename {} \; | sort)

    menu_opts+=("Delete ALL|Remove all templates")
    
    choose_menu "Select Template" "${menu_opts[@]}"
    choice=$MENU_RESULT

    # Check if cancelled
    if [[ $choice -eq -1 ]]; then
        return 0
    fi

    # Handle delete all (last option)
    if [[ $choice -eq $((${#menu_opts[@]} - 1)) ]]; then
        echo ""
        echo -e "${RED}${BOLD}âš  WARNING: This will delete ALL ${#templates[@]} templates!${RESET}"
        read -r -p "Are you sure? Type 'yes' to confirm: " confirm_all
        if [[ "$confirm_all" == "yes" ]]; then
            for tmpl in "${templates[@]}"; do
                rm -f "$TEMPLATE_DIR/${tmpl}.sh"
                echo -e "${GREEN}âœ“${RESET} Deleted: $tmpl"
            done
            echo ""
            echo -e "${GREEN}âœ“ All templates deleted${RESET}"
        else
            echo -e "${YELLOW}Cancelled${RESET}"
        fi
        return 0
    fi

    # Valid template selected (MENU_RESULT is 0-based)
    local selected="${templates[$choice]}"
    delete_template "$selected"
}

# Delete specific template
delete_template() {
    local name="$1"
    local template_file="$TEMPLATE_DIR/${name}.sh"

    if [[ ! -f "$template_file" ]]; then
        echo -e "${RED}âœ— Template not found: ${CYAN}$name${RESET}"
        echo -e "  Location: ${CYAN}$template_file${RESET}"
        return 1
    fi

    echo ""
    echo -e "${YELLOW}Template to delete:${RESET}"
    echo -e "  Name: ${CYAN}$name${RESET}"
    echo -e "  File: ${CYAN}$template_file${RESET}"
    echo -e "  Size: $(du -h "$template_file" | cut -f1)"
    echo ""
    
    read -r -p "Are you sure you want to delete this template? (y/N): " confirm
    
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        rm -f "$template_file"
        echo -e "${GREEN}âœ“ Template deleted: ${CYAN}$name${RESET}"
    else
        echo -e "${YELLOW}Cancelled${RESET}"
    fi
}

# Main
case "${1:-}" in
    -h|--help|help)
        show_help
        exit 0
        ;;
    -i|--interactive)
        interactive_delete
        ;;
    "")
        interactive_delete
        ;;
    *)
        delete_template "$1"
        ;;
esac
